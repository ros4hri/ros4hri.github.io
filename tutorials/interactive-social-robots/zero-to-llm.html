

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build a complete LLM-enabled interactive app with ROS4HRI perception and skills &mdash; ROS4HRI: ROS for Human-Robot Interaction 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/style/main.css?v=8e287a83" />

  
    <link rel="shortcut icon" href="../../_static/icon.png"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" data-goatcounter="https://ros4hri.goatcounter.com/count" src="https://gc.zgo.at/count.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Compatible Robots" href="../../robots.html" />
    <link rel="prev" title="Tutorials" href="../../tutorials.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ROS4HRI: ROS for Human-Robot Interaction
              <img src="../../_static/logo_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">The ROS4HRI Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../standard.html">The ROS4HRI Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages.html">Open-source ROS4HRI packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skills/index.html">ROS4HRI Standard Skills</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Build a complete LLM-enabled interactive app with ROS4HRI perception and skills</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#part-0-preparing-your-environment">PART 0: Preparing your environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-the-public-pal-tutorials-docker-image">Get the public PAL tutorials Docker image</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#part-1-warm-up-with-face-detection">PART 1: Warm-up with face detection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#start-the-webcam-node">Start the webcam node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#face-detection">Face detection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#part-2-the-social-interaction-simulator">PART 2: the social interaction simulator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-interaction-simulator">Starting the interaction simulator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interaction-simulator-architecture">Interaction simulator architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-simulator-to-add-symbolic-knowledge">Using the simulator to add symbolic knowledge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-the-knowledge-base-from-python">Accessing the knowledge base from Python</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#part-3-building-a-simple-social-behaviour">PART 3: Building a simple social behaviour</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#our-first-mission-controller">Our first mission controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-1-generating-the-mission-controller">Step 1: generating the mission controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-add-basic-interactivity">Step 2: add basic interactivity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-3-emotion-mimicking-game">Step 3: emotion mimicking game</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#part-4-integration-with-llms">PART 4: Integration with LLMs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-chatbot">Adding a chatbot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integrating-with-a-large-language-model-llm">Integrating with a Large Language Model (LLM)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../robots.html">Compatible Robots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">Who is behind ROS4HRI?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ROS4HRI: ROS for Human-Robot Interaction</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Build a complete LLM-enabled interactive app with ROS4HRI perception and skills</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/interactive-social-robots/zero-to-llm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="build-a-complete-llm-enabled-interactive-app-with-ros4hri-perception-and-skills">
<span id="zero-to-llm"></span><h1>Build a complete LLM-enabled interactive app with ROS4HRI perception and skills<a class="headerlink" href="#build-a-complete-llm-enabled-interactive-app-with-ros4hri-perception-and-skills" title="Link to this heading">ÔÉÅ</a></h1>
<p>This tutorial will guide you through the installation and use of the
ROS4HRI framework, a set of ROS nodes and tools to build interactive
social robots.</p>
<p>We will use a set of pre-configured Docker containers to simplify the
setup process.</p>
<p>We will also explore how a simple yet complete social robot architecture
can be assembled using ROS 2, PAL Robotics‚Äô toolset to quickly generate
robot application templates, and a LLM backend.</p>
<figure class="align-center" id="id1" style="width: 50%">
<a class="reference internal image-reference" href="../../_images/social-interaction-simulator.jpg"><img alt="Social interaction simulator" src="../../_images/social-interaction-simulator.jpg" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Social interaction simulator</span><a class="headerlink" href="#id1" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<section id="part-0-preparing-your-environment">
<h2>PART 0: Preparing your environment<a class="headerlink" href="#part-0-preparing-your-environment" title="Link to this heading">ÔÉÅ</a></h2>
<section id="pre-requisites">
<h3>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Link to this heading">ÔÉÅ</a></h3>
<p>To follow ‚Äòhands-on‚Äô the tutorial, you will need to be able to run a
Docker container on your machine, with access to a X server (to display
graphical applications like <code class="docutils literal notranslate"><span class="pre">rviz</span></code> and <code class="docutils literal notranslate"><span class="pre">rqt</span></code>). We will also use the
webcam of your computer.</p>
<p>Any recent Linux distribution should work, as well as MacOS (with
XQuartz installed).</p>
<p>The tutorial alo assumes that you have a basic understanding of ROS 2
concepts (topics, nodes, launch files, etc). If you are not familiar
with ROS 2, you can check the <a class="reference external" href="https://docs.ros.org/en/jazzy/Tutorials.html">official ROS 2
tutorials</a>.</p>
</section>
<section id="get-the-public-pal-tutorials-docker-image">
<h3>Get the public PAL tutorials Docker image<a class="headerlink" href="#get-the-public-pal-tutorials-docker-image" title="Link to this heading">ÔÉÅ</a></h3>
<p>Fetch the <code class="docutils literal notranslate"><span class="pre">PAL</span> <span class="pre">tutorials</span></code> public Docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">pull</span> <span class="n">palrobotics</span><span class="o">/</span><span class="n">public</span><span class="o">-</span><span class="n">tutorials</span><span class="o">-</span><span class="n">alum</span><span class="o">-</span><span class="n">devel</span><span class="p">:</span><span class="n">latest</span>
</pre></div>
</div>
<p>Then, run the container, with access to your webcam and your X server.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>xhost<span class="w"> </span>+
mkdir<span class="w"> </span>ros4hri-exchange
docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--name<span class="w"> </span>ros4hri<span class="w"> </span><span class="se">\</span>
<span class="w">               </span>--device<span class="w"> </span>/dev/video0:/dev/video0<span class="w"> </span><span class="se">\</span>
<span class="w">               </span>-e<span class="w"> </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span><span class="w"> </span><span class="se">\</span>
<span class="w">               </span>-v<span class="w"> </span>/tmp/.X11-unix:/tmp/.X11-unix<span class="w"> </span><span class="se">\</span>
<span class="w">               </span>-v<span class="w"> </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/ros4hri-exchange:/home/user/exchange<span class="w"> </span><span class="se">\</span>
<span class="w">               </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">               </span>palrobotics/public-tutorials-alum-devel:latest<span class="w"> </span>bash
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--device</span></code> option is used to pass the webcam to the
container, and the <code class="docutils literal notranslate"><span class="pre">-e:</span> <span class="pre">DISPLAY</span></code> and
<code class="docutils literal notranslate"><span class="pre">-v</span> <span class="pre">/tmp/.X11-unix:/tmp/.X11-unix</span></code> options are used to display
graphical applications on your screen.</p>
</div>
</section>
</section>
<section id="part-1-warm-up-with-face-detection">
<h2>PART 1: Warm-up with face detection<a class="headerlink" href="#part-1-warm-up-with-face-detection" title="Link to this heading">ÔÉÅ</a></h2>
<section id="start-the-webcam-node">
<h3>Start the webcam node<a class="headerlink" href="#start-the-webcam-node" title="Link to this heading">ÔÉÅ</a></h3>
<p>First, let‚Äôs start a webcam node to publish images from the webcam to
ROS.</p>
<p>In the terminal, type:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>gscam<span class="w"> </span>gscam_node<span class="w"> </span>--ros-args<span class="w"> </span>-p<span class="w"> </span>gscam_config:<span class="o">=</span><span class="s1">&#39;v4l2src device=/dev/video0 ! video/x-raw,framerate=30/1 ! videoconvert&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                                     </span>-p<span class="w"> </span>use_sensor_data_qos:<span class="o">=</span>True<span class="w"> </span><span class="se">\</span>
<span class="w">                                     </span>-p<span class="w"> </span>camera_name:<span class="o">=</span>camera<span class="w"> </span><span class="se">\</span>
<span class="w">                                     </span>-p<span class="w"> </span>frame_id:<span class="o">=</span>camera<span class="w"> </span><span class="se">\</span>
<span class="w">                                     </span>-p<span class="w"> </span>camera_info_url:<span class="o">=</span>package://interaction_sim/config/camera_info.yaml
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">gscam</span></code> node is a ROS 2 node that captures images from a
webcam and publishes them on a ROS topic. The <code class="docutils literal notranslate"><span class="pre">gscam_config</span></code>
parameter is used to specify the webcam device to use
(<code class="docutils literal notranslate"><span class="pre">/dev/video0</span></code>), and the <code class="docutils literal notranslate"><span class="pre">camera_info_url</span></code> parameter is used to
specify the camera calibration file. We use a default calibration
file that works reasonably well with most webcams.</p>
</div>
<p>You can open <code class="docutils literal notranslate"><span class="pre">rqt</span></code> to check that the images are indeed published:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rqt
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to open another Docker terminal, run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-u<span class="w"> </span>user<span class="w"> </span>ros4hri<span class="w"> </span>bash
</pre></div>
</div>
</div>
<p>Then, in the <code class="docutils literal notranslate"><span class="pre">Plugins</span></code> menu, select <code class="docutils literal notranslate"><span class="pre">Visualization</span> <span class="pre">&gt;</span> <span class="pre">Image</span> <span class="pre">View</span></code>,
and choose the topic <code class="docutils literal notranslate"><span class="pre">/camera/image_raw</span></code>:</p>
<figure class="align-default" id="id2" style="width: 400px">
<a class="reference internal image-reference" href="../../_images/rqt-image-view.jpg"><img alt="rqt image view" src="../../_images/rqt-image-view.jpg" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-text">rqt image view</span><a class="headerlink" href="#id2" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</section>
<section id="face-detection">
<h3>Face detection<a class="headerlink" href="#face-detection" title="Link to this heading">ÔÉÅ</a></h3>
<p><a class="reference external" href="https://github.com/ros4hri/hri_face_detect">hri_face_detect</a> is
an open-source ROS 1/ROS 2 node, compatible with ROS4HRI, that detects
faces in images.</p>
<p>It is already installed in the Docker container.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">hri_face_detect</span></code> expect images on <code class="docutils literal notranslate"><span class="pre">/image</span></code> topic:
before starting the node, we need to configure topic remapping:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/.pal/config
nano<span class="w"> </span><span class="nv">$HOME</span>/.pal/config/ros4hri-tutorials.yml
</pre></div>
</div>
<p>Then, paste the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/hri_face_detect</span><span class="p">:</span>
<span class="w">   </span><span class="nt">remappings</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/camera/image_raw</span>
<span class="w">      </span><span class="nt">camera_info</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/camera/camera_info</span>
</pre></div>
</div>
<p>Press <code class="docutils literal notranslate"><span class="pre">Ctrl+O</span></code> to save, then <code class="docutils literal notranslate"><span class="pre">Ctrl+X</span></code> to exit.</p>
<p>Then, you can launch the node:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>hri_face_detect<span class="w"> </span>face_detect.launch.py
</pre></div>
</div>
<p>You should see on your console <em>which</em> configuration files are used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ros2 launch hri_face_detect face_detect.launch.py
[INFO] [launch]: All log files can be found below /home/user/.ros/log/2024-10-16-12-39-10-518981-536d911a0c9c-203
[INFO] [launch]: Default logging verbosity is set to INFO
[INFO] [launch.user]: Loaded configuration for &lt;hri_face_detect&gt;:
- System configuration (from lower to higher precedence):
    - /opt/pal/alum/share/hri_face_detect/config/00-defaults.yml
- User overrides (from lower to higher precedence):
    - /home/user/.pal/config/ros4hri-tutorials.yml
[INFO] [launch.user]: Parameters:
- processing_rate: 30
- confidence_threshold: 0.75
- image_scale: 0.5
- face_mesh: True
- filtering_frame: camera_color_optical_frame
- deterministic_ids: False
- debug: False
[INFO] [launch.user]: Remappings:
- image -&gt; /camera/image_raw
- camera_info -&gt; /camera/camera_info
[INFO] [face_detect-1]: process started with pid [214]
...
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This way of managing launch parameters and remapping is not part
of base ROS 2: it is an extension (available in ROS humble) provided
by PAL Robotics to simplify the management of ROS 2 nodes
configuration.</p>
<p>See for instance the <a class="reference external" href="https://github.com/ros4hri/hri_face_detect/blob/humble-devel/launch/face_detect.launch.py#L31">launch file of
hri_face_detect</a>
to understand how it is used.</p>
</div>
<p>You should immediately see on the console that some faces are indeed
detected</p>
<p>Let‚Äôs visualise them:</p>
<ol class="arabic simple">
<li><p>start <code class="docutils literal notranslate"><span class="pre">rviz2</span></code>:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rviz2
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>In <code class="docutils literal notranslate"><span class="pre">rviz</span></code>, visualize the detected faces by adding the <code class="docutils literal notranslate"><span class="pre">Humans</span></code>
plugin, which you can find in the <code class="docutils literal notranslate"><span class="pre">hri_rviz</span></code> plugins group. The
plugin setup requires you to specify the image stream you want to use
to visualize the detection results, in this case
<code class="docutils literal notranslate"><span class="pre">/camera/image_raw</span></code>. You can also find the plugin as one of those
available for the <code class="docutils literal notranslate"><span class="pre">/camera/image_raw</span></code> topic.</p></li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Set the quality of service (QoS) of the
<code class="docutils literal notranslate"><span class="pre">/camera/image_raw</span></code> topic to <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Effort</span></code>, otherwise no image will be displayed:</p>
<figure class="align-default" id="id3" style="width: 400px">
<a class="reference internal image-reference" href="../../_images/rviz-humans-qos.png"><img alt="Set the QoS of the ``/camera/image_raw`` topic to ``Best Effort``" src="../../_images/rviz-humans-qos.png" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-text">Set the QoS of the <code class="docutils literal notranslate"><span class="pre">/camera/image_raw</span></code> topic to <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Effort</span></code></span><a class="headerlink" href="#id3" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</div>
<ol class="arabic simple" start="3">
<li><p>In <code class="docutils literal notranslate"><span class="pre">rviz</span></code>, enable as well the <code class="docutils literal notranslate"><span class="pre">tf</span></code> plugin, and set the fixed
frame to <code class="docutils literal notranslate"><span class="pre">camera</span></code>. You should now see a 3D frame, representing the
face position and orientation of your face.</p></li>
</ol>
<figure class="align-default" id="id4" style="width: 400px">
<a class="reference internal image-reference" href="../../_images/rviz-face.jpg"><img alt="rviz showing a 3D face frame" src="../../_images/rviz-face.jpg" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-text">rviz showing a 3D face frame</span><a class="headerlink" href="#id4" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="part-2-the-social-interaction-simulator">
<h2>PART 2: the social interaction simulator<a class="headerlink" href="#part-2-the-social-interaction-simulator" title="Link to this heading">ÔÉÅ</a></h2>
<section id="starting-the-interaction-simulator">
<h3>Starting the interaction simulator<a class="headerlink" href="#starting-the-interaction-simulator" title="Link to this heading">ÔÉÅ</a></h3>
<p>Instead of running nodes manually, we are now going to use the ROS4HRI
<em>interaction simulator</em> <a class="reference external" href="https://github.com/ros4hri/interaction_sim">interaction_sim</a>:</p>
<figure class="align-default" id="id5">
<a class="reference internal image-reference" href="../../_images/interaction_sim.jpg"><img alt="Social interaction simulator" src="../../_images/interaction_sim.jpg" style="width: 70%;" />
</a>
<figcaption>
<p><span class="caption-text">Social interaction simulator</span><a class="headerlink" href="#id5" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p><strong>To start the simulator:</strong></p>
<ol class="arabic simple">
<li><p>stop all the nodes that are running (like <code class="docutils literal notranslate"><span class="pre">gscam</span></code>,
<code class="docutils literal notranslate"><span class="pre">hri_face_detect</span></code>, <code class="docutils literal notranslate"><span class="pre">rqt,</span></code> etc)</p></li>
<li><p>in one of your Docker terminals, launch the simulator:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">launch</span> <span class="n">interaction_sim</span> <span class="n">simulator</span><span class="o">.</span><span class="n">launch</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p><strong>To load a pre-configured scene:</strong></p>
<p>On the screenshot above, the objets (sofa, table, etc) are defined in an
custom SVG file.</p>
<p>You can load such a pre-configured scene:</p>
<ol class="arabic simple">
<li><p>click on <span class="guilabel">Settings</span>, then <span class="guilabel">Download environment SVG template</span> and
save the file in the <code class="docutils literal notranslate"><span class="pre">exchange</span></code> folder (call it for instance
<code class="docutils literal notranslate"><span class="pre">scene.svg</span></code>).</p></li>
<li><p>click on <span class="guilabel">Load environment</span> and select the file you just saved.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can open the SVG file in a vector editor like Inkscape to
modify the scene (add new objects, change the layout, etc). Check the
instructions written in the template itself.</p>
</div>
</section>
<section id="interaction-simulator-architecture">
<h3>Interaction simulator architecture<a class="headerlink" href="#interaction-simulator-architecture" title="Link to this heading">ÔÉÅ</a></h3>
<p>The interaction simulator starts several nodes:</p>
<p>The previous two:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://github.com/ros-drivers/gscam/tree/ros2">gscam</a> to
publish images from the webcam</p></li>
<li><p><a class="reference external" href="https://github.com/ros4hri/hri_face_detect">hri_face_detect</a>
to detect faces in images</p></li>
</ol>
<p>And the following new nodes:</p>
<ol class="arabic simple" start="3">
<li><p><a class="reference external" href="https://github.com/ros4hri/hri_person_manager">hri_person_manager</a>,
to ‚Äòcombine‚Äô faces, bodies, voices into full persons</p></li>
<li><p><a class="reference external" href="https://github.com/ros4hri/hri_emotion_recognizer">hri_emotion_recognizer</a>,
to recognize emotions on the detected faces</p></li>
<li><p><a class="reference external" href="https://github.com/severin-lemaignan/knowledge_core">knowledge_core</a>,
an open-source OWL/RDF-based knowledge base</p></li>
<li><p><a class="reference external" href="https://github.com/ros4hri/hri_visualization">hri_visualization</a>
to generate a camera image overlay with the faces, bodies, emotions,
etc</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attention_manager</span></code> (not open-source), that decides where to look
based on the where the faces are</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expressive_eyes</span></code> (not open-source), that procedurally generates
the robot‚Äôs face and moves the eyes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">communication_hub</span></code> (not open-source), that manages the dialogues
with the user (user input speech, and robot output speech)</p></li>
</ol>
<p>Finally, it launches <code class="docutils literal notranslate"><span class="pre">rqt</span></code> with two custom plugins:</p>
<ol class="arabic simple" start="10">
<li><p><a class="reference external" href="https://github.com/ros4hri/rqt_human_radar">rqt_human_radar</a>,
to visualize the detected people around the robot (and simulated
interactions with a knowledge base)</p></li>
<li><p><a class="reference external" href="https://github.com/ros4hri/rqt_chat">rqt_chat</a>, to chat
with the robot. When you type a message, it is sent to the ROS4HRI
topic <code class="docutils literal notranslate"><span class="pre">/humans/voices/anonymous_speaker/speech</span></code>, and the robot‚Äôs
response via the <code class="docutils literal notranslate"><span class="pre">/tts_engine/tts</span></code> action are displayed back.</p></li>
</ol>
<p>The next figure shows the architecture of the interaction simulator:</p>
<figure class="align-default" id="id6">
<a class="reference internal image-reference" href="../../_images/interaction-simulator-architecture.svg"><img alt="Interaction simulator architecture" src="../../_images/interaction-simulator-architecture.svg" style="width: 70%;" />
</a>
<figcaption>
<p><span class="caption-text">Interaction simulator architecture</span><a class="headerlink" href="#id6" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</section>
<section id="using-the-simulator-to-add-symbolic-knowledge">
<h3>Using the simulator to add symbolic knowledge<a class="headerlink" href="#using-the-simulator-to-add-symbolic-knowledge" title="Link to this heading">ÔÉÅ</a></h3>
<p>When starting the simulator, <a class="reference external" href="https://github.com/severin-lemaignan/knowledge_core">knowledge_core</a> is also started.
<code class="docutils literal notranslate"><span class="pre">knowledge_core</span></code> is a simple OWL/RDF-based knowledge base that can be
used to store symbolic information about the world.</p>
<p>By right-clicking on the top-down view of the environment, you can add
new objects to the knowledge base:</p>
<figure class="align-default" id="id7" style="width: 600px">
<a class="reference internal image-reference" href="../../_images/interaction_sim_facts.png"><img alt="Adding a new object to the knowledge base" src="../../_images/interaction_sim_facts.png" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-text">Adding a new object to the knowledge base</span><a class="headerlink" href="#id7" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p>The simulator will then publish the new facts on to the knowledge base,
including whether or not a given object is in the field of view of the
robot and/or humans (eg <code class="docutils literal notranslate"><span class="pre">myself</span> <span class="pre">sees</span> <span class="pre">cup_abcd</span></code> or
<code class="docutils literal notranslate"><span class="pre">person_lkhgx</span> <span class="pre">sees</span> <span class="pre">sofa</span></code>).</p>
<p>To visualize the knowledge base, we need to start the web-based
knowledge base viewer.</p>
<p>In a new terminal, start the viewer:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>knowledge_core<span class="w"> </span>knowledge_viewer.launch.py
</pre></div>
</div>
<p>Then, open your web browser at <code class="docutils literal notranslate"><span class="pre">http://localhost:8000</span></code> to explore the
knowledge base.</p>
<p>For instance, with the following scene:</p>
<figure class="align-default" id="id8" style="width: 500px">
<a class="reference internal image-reference" href="../../_images/scene_kb.png"><img alt="Scene with a sofa and a cup" src="../../_images/scene_kb.png" style="width: 500px;" />
</a>
<figcaption>
<p><span class="caption-text">Scene with a sofa and a cup</span><a class="headerlink" href="#id8" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p>the knowledge base will contain new facts, including:</p>
<figure class="align-default" id="id9" style="width: 600px">
<a class="reference internal image-reference" href="../../_images/kb.png"><img alt="Knowledge base viewer" src="../../_images/kb.png" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-text">Knowledge base viewer</span><a class="headerlink" href="#id9" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The robot‚Äôs own ‚Äòinstance‚Äô is always called <code class="docutils literal notranslate"><span class="pre">myself</span></code> in the
knowledge base.</p>
<p>For instance <code class="docutils literal notranslate"><span class="pre">myself</span> <span class="pre">sees</span> <span class="pre">cup_oojnc</span></code> means that the robot sees the
cup <code class="docutils literal notranslate"><span class="pre">cup_oojnc</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of Feb 2025, <code class="docutils literal notranslate"><span class="pre">rqt_human_radar</span></code> computes and pushes to the
knowledge base the following facts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;object|agent&gt;</span> <span class="pre">rdf:type</span> <span class="pre">&lt;class&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">myself</span> <span class="pre">sees</span> <span class="pre">&lt;object&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">person_&lt;id&gt;</span> <span class="pre">sees</span> <span class="pre">&lt;object&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;object|agent&gt;</span> <span class="pre">isIn</span> <span class="pre">&lt;zone&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;object|agent&gt;</span> <span class="pre">isOn</span> <span class="pre">&lt;object&gt;</span></code></p></li>
</ul>
<p>(note that the field of view of the robot/humans does not take walls
into account yet!)</p>
</div>
</section>
<section id="accessing-the-knowledge-base-from-python">
<h3>Accessing the knowledge base from Python<a class="headerlink" href="#accessing-the-knowledge-base-from-python" title="Link to this heading">ÔÉÅ</a></h3>
<p>You can easily query the knowledge base from Python:</p>
<p>Start <code class="docutils literal notranslate"><span class="pre">ipython3</span></code> in the terminal:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ipython3
</pre></div>
</div>
<p>Then, in the Python shell:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">knowledge_core.api</span> <span class="kn">import</span> <span class="n">KB</span>
<span class="n">kb</span> <span class="o">=</span> <span class="n">KB</span><span class="p">()</span>

<span class="n">kb</span><span class="p">[</span><span class="s2">&quot;* sees *&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This will return all the facts in the knowledge base that match the
pattern <code class="docutils literal notranslate"><span class="pre">*</span> <span class="pre">sees</span> <span class="pre">*</span></code> (ie, all the objects that are seen by someone).</p>
<p>Likewise,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kb</span><span class="p">[</span><span class="s2">&quot;* isIn kitchen&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>will return all the objects (or simulated humans) that are in the
kitchen.</p>
<p>You can also create more complex queries by passing a <em>list</em> of semantic
patterns and using <em>named variables</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kb</span><span class="p">[[</span><span class="s2">&quot;?h sees ?o&quot;</span><span class="p">,</span> <span class="s2">&quot;?o rdf:type dbr:Cup&quot;</span><span class="p">,</span> <span class="s2">&quot;?h rdf:type Human&quot;</span><span class="p">]]</span>
</pre></div>
</div>
<p>This will return all the facts in the knowledge base where a human sees
a cup.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note the <code class="docutils literal notranslate"><span class="pre">dbr:</span></code> prefix in front of <code class="docutils literal notranslate"><span class="pre">Cup</span></code>: the simulator uses
the ‚Äòcup‚Äô concept <a class="reference external" href="http://dbpedia.org/resource/Cup">defined in the DBPedia ontology</a>.</p>
</div>
<div class="admonition-learn-more admonition">
<p class="admonition-title">üìö Learn more</p>
<p>To learn mode about PAL interaction simulator, check PAL Robotics‚Äô
<a class="reference external" href="https://docs.pal-robotics.com/edge/development/interaction-simulator">public
documentation</a>.</p>
</div>
</section>
</section>
<section id="part-3-building-a-simple-social-behaviour">
<h2>PART 3: Building a simple social behaviour<a class="headerlink" href="#part-3-building-a-simple-social-behaviour" title="Link to this heading">ÔÉÅ</a></h2>
<section id="our-first-mission-controller">
<h3>Our first mission controller<a class="headerlink" href="#our-first-mission-controller" title="Link to this heading">ÔÉÅ</a></h3>
<p>A mission controller is a ROS node that orchestrates the robot‚Äôs
behaviour.</p>
<p>We will implement our first mission controller as a simple Python script
that copies your facial expression onto the robot‚Äôs face: an emotion
mirroring game.</p>
<p>Since creating a complete ROS 2 node from scratch can be a bit tedious,
we will use the <a class="reference internal" href="../../tools/rpk.html#rpk"><span class="std std-ref">rpk</span></a> tool, a command-line
tool created by PAL Robotics, that generates ROS 2 nodes from templates.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">rpk</span></code> is already installed in the Docker container. You can also
install it easily on your own machines with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">rpk</span></code></p>
<p>As the generator tool itself does not require ROS, you can use it on
any machine, including eg Windows.</p>
<p>Learn more about <a class="reference internal" href="../../tools/rpk.html#rpk"><span class="std std-ref">Automatic code generation with rpk</span></a>.</p>
</div>
</section>
<section id="step-1-generating-the-mission-controller">
<h3>Step 1: generating the mission controller<a class="headerlink" href="#step-1-generating-the-mission-controller" title="Link to this heading">ÔÉÅ</a></h3>
<ul class="simple">
<li><p>go to your <code class="docutils literal notranslate"><span class="pre">exchange</span></code> folder and create a new workspace:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/exchange

<span class="c1"># you might have to change the rights of the folder</span>
sudo<span class="w"> </span>chown<span class="w"> </span>user:user<span class="w"> </span>.

mkdir<span class="w"> </span>ws
<span class="nb">cd</span><span class="w"> </span>ws
</pre></div>
</div>
<ul class="simple">
<li><p>run <code class="docutils literal notranslate"><span class="pre">rpk</span></code> to create the mission controller:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>rpk<span class="w"> </span>create<span class="w"> </span>-p<span class="w"> </span>src/<span class="w"> </span>mission
ID<span class="w"> </span>of<span class="w"> </span>your<span class="w"> </span>application?<span class="w"> </span><span class="o">(</span>must<span class="w"> </span>be<span class="w"> </span>a<span class="w"> </span>valid<span class="w"> </span>ROS<span class="w"> </span>identifier<span class="w"> </span>without<span class="w"> </span>spaces<span class="w"> </span>or<span class="w"> </span>hyphens.<span class="w"> </span>eg<span class="w"> </span><span class="s1">&#39;robot_receptionist&#39;</span><span class="o">)</span>
emotion_mirror
Full<span class="w"> </span>name<span class="w"> </span>of<span class="w"> </span>your<span class="w"> </span>skill/application?<span class="w"> </span><span class="o">(</span>eg<span class="w"> </span><span class="s1">&#39;The Receptionist Robot&#39;</span><span class="w"> </span>or<span class="w"> </span><span class="s1">&#39;Database connector&#39;</span>,<span class="w"> </span>press<span class="w"> </span>Return<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span>ID.<span class="w"> </span>You<span class="w"> </span>can<span class="w"> </span>change<span class="w"> </span>it<span class="w"> </span>later<span class="o">)</span>


Choose<span class="w"> </span>a<span class="w"> </span>template:
<span class="m">1</span>:<span class="w"> </span>base<span class="w"> </span>robot<span class="w"> </span>supervisor<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>
<span class="m">2</span>:<span class="w"> </span>robot<span class="w"> </span>supervisor<span class="w"> </span>with<span class="w"> </span>pre-filled<span class="w"> </span>intent<span class="w"> </span>handlers<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>
<span class="m">3</span>:<span class="w"> </span>robot<span class="w"> </span>supervisor<span class="w"> </span>with<span class="w"> </span>a<span class="w"> </span>GUI<span class="w"> </span>and<span class="w"> </span>pre-filled<span class="w"> </span>intent<span class="w"> </span>handlers<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>
<span class="m">4</span>:<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>supervisor<span class="w"> </span>example,<span class="w"> </span>using<span class="w"> </span>a<span class="w"> </span>basic<span class="w"> </span>chatbot<span class="w"> </span>to<span class="w"> </span>manage<span class="w"> </span>interactions<span class="w"> </span>with<span class="w"> </span>users<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>
<span class="m">5</span>:<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>supervisor<span class="w"> </span>example,<span class="w"> </span>using<span class="w"> </span>LLMs<span class="w"> </span>to<span class="w"> </span>manage<span class="w"> </span>interactions<span class="w"> </span>with<span class="w"> </span>users<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>

Your<span class="w"> </span>choice?<span class="w"> </span><span class="m">1</span>

What<span class="w"> </span>robot<span class="w"> </span>are<span class="w"> </span>you<span class="w"> </span>targeting?
<span class="m">1</span>:<span class="w"> </span>Generic<span class="w"> </span>robot<span class="w"> </span><span class="o">(</span>generic<span class="o">)</span>
<span class="m">2</span>:<span class="w"> </span>Generic<span class="w"> </span>PAL<span class="w"> </span>robot/simulator<span class="w"> </span><span class="o">(</span>generic-pal<span class="o">)</span>
<span class="m">3</span>:<span class="w"> </span>PAL<span class="w"> </span>ARI<span class="w"> </span><span class="o">(</span>ari<span class="o">)</span>
<span class="m">4</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span><span class="o">(</span>tiago<span class="o">)</span>
<span class="m">5</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span>Pro<span class="w"> </span><span class="o">(</span>tiago-pro<span class="o">)</span>
<span class="m">6</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span>Head<span class="w"> </span><span class="o">(</span>tiago-head<span class="o">)</span>

Your<span class="w"> </span>choice?<span class="w"> </span><span class="o">(</span>default:<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>generic<span class="o">)</span><span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<p>Choose a <code class="docutils literal notranslate"><span class="pre">base</span> <span class="pre">robot</span> <span class="pre">supervisor</span></code> template, and the <code class="docutils literal notranslate"><span class="pre">generic-pal</span></code>
robot.</p>
<p>The tool will then create a complete ROS 2 mission controller, ready to
listen to incoming user intents (eg, ROS messages pubished on the
<code class="docutils literal notranslate"><span class="pre">/intents</span></code> topic).</p>
<ul class="simple">
<li><p>build and source the workspace:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>colcon<span class="w"> </span>build

<span class="nb">source</span><span class="w"> </span>install/setup.bash
</pre></div>
</div>
<ul class="simple">
<li><p>start the mission controller:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>emotion_mirror<span class="w"> </span>emotion_mirror.launch.py
</pre></div>
</div>
<p>If you now write a line in the <code class="docutils literal notranslate"><span class="pre">rqt_chat</span></code> plugin, you should see the
mission controller reacting to it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">[</span><span class="n">run_app</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">[</span><span class="mf">1729672049.773179100</span><span class="p">]</span> <span class="p">[</span><span class="n">emotion_mirror</span><span class="p">]:</span> <span class="n">Listening</span> <span class="n">to</span> <span class="o">/</span><span class="n">intents</span> <span class="n">topic</span>
<span class="p">[</span><span class="n">run_app</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">[</span><span class="mf">1729672099.529532393</span><span class="p">]</span> <span class="p">[</span><span class="n">emotion_mirror</span><span class="p">]:</span> <span class="n">Received</span> <span class="n">an</span> <span class="n">intent</span><span class="p">:</span> <span class="n">__raw_user_input__</span>
<span class="p">[</span><span class="n">run_app</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">[</span><span class="mf">1729672099.529859652</span><span class="p">]</span> <span class="p">[</span><span class="n">emotion_mirror</span><span class="p">]:</span> <span class="n">Processing</span> <span class="nb">input</span><span class="p">:</span> <span class="n">__raw_user_input__</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">rqt_chat</span></code> displays ‚ÄòProcessing‚Ä¶‚Äô as it waits for a response
from the mission controller. The mission controller is not doing
anything yet, so nothing else will be displayed (for now!).</p>
</div>
<p>The intent <code class="docutils literal notranslate"><span class="pre">__raw_user_input__</span></code> is emitted by the
<code class="docutils literal notranslate"><span class="pre">communication_hub</span></code>, and is a special intent that essentially means:
‚ÄúI don‚Äôt know what to do with this input, but I received it‚Äù.</p>
<p>Since we are not doing anything with the input yet (like trying to
figure out what the user wants be calling a dedicated chatbot), the
communication hub simply sends back the same message with this intent.</p>
</section>
<section id="step-2-add-basic-interactivity">
<h3>Step 2: add basic interactivity<a class="headerlink" href="#step-2-add-basic-interactivity" title="Link to this heading">ÔÉÅ</a></h3>
<p>Modify the template to say something back. To start with, we will always
respond the same thing. We can use the <code class="docutils literal notranslate"><span class="pre">say</span></code> skill to get the robot to speak.</p>
<ul class="simple">
<li><p>open <code class="docutils literal notranslate"><span class="pre">mission_controller.py</span></code>:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>src/emotion_mirror/emotion_mirror
nano<span class="w"> </span>mission_controller.py
</pre></div>
</div>
<ul class="simple">
<li><p>in the constructor, create a action client (the <code class="docutils literal notranslate"><span class="pre">say</span></code> skill:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">#...</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">ActionClient</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">communication_skills.action</span> <span class="kn">import</span> <span class="n">Say</span>
<span class="linenos"> 4</span><span class="c1">#...</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">class</span> <span class="nc">MissionController</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="c1">#...</span>
<span class="linenos">10</span>        <span class="bp">self</span><span class="o">.</span><span class="n">say</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Say</span><span class="p">,</span> <span class="s1">&#39;/skill/say&#39;</span><span class="p">)</span>
<span class="linenos">11</span>        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>modify the handling on incoming intents to say something back:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>    <span class="k">def</span> <span class="nf">on_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="linenos">2</span>        <span class="c1">#...</span>
<span class="linenos">3</span>
<span class="linenos">4</span>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="n">Intent</span><span class="o">.</span><span class="n">RAW_USER_INPUT</span><span class="p">:</span>
<span class="linenos">5</span>            <span class="n">goal</span> <span class="o">=</span> <span class="n">Say</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
<span class="linenos">6</span>            <span class="n">goal</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s2">&quot;I&#39;m the famous emotion mirroring robot! (but I&#39;m not great at chatting yet)&quot;</span>
<span class="linenos">7</span>            <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
</pre></div>
</div>
<p>(up to you to come up with something funny!)</p>
<p>Re-run <code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span></code> and relaunch your mission controller to test it
with the chat interface:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/exchange/ws<span class="w"> </span><span class="c1"># always run colcon build from the workspace root</span>
colcon<span class="w"> </span>build
ros2<span class="w"> </span>launch<span class="w"> </span>emotion_mirror<span class="w"> </span>emotion_mirror.launch.py
</pre></div>
</div>
<p>Since we are using <code class="docutils literal notranslate"><span class="pre">communication_hub</span></code> as a middle-man, we can also
use markup in our sentences to change the expression of the robot.</p>
<p>For example, you can use the following markup to display an happy face:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;&lt;set expression(happy)&gt; I&#39;m the famous emotion mirroring robot! My holiday was great &lt;set expression(amazed)&gt;, thank you for asking! &lt;set expression(neutral)&gt;&quot;</span>
</pre></div>
</div>
<div class="admonition-learn-more admonition">
<p class="admonition-title">üìö Learn more</p>
<p>You can check the online documentation of the <a class="reference external" href="https://docs.pal-robotics.com/edge/communication/tts_howto#multi-modal-expression-markup-language">markup
language</a>
used by the <code class="docutils literal notranslate"><span class="pre">communication_hub</span></code> to get the list of available
actions and expressions.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">communication_hub</span></code>, while available in binary form in
the Docker image, is not open-source. Alternatively, you can also
simply manually set the robot‚Äôs expression by publishing on the
<code class="docutils literal notranslate"><span class="pre">/robot_face/expression</span></code> topic (as we do below).</p>
</div>
</section>
<section id="step-3-emotion-mimicking-game">
<span id="emotion-mimicking-game"></span><h3>Step 3: emotion mimicking game<a class="headerlink" href="#step-3-emotion-mimicking-game" title="Link to this heading">ÔÉÅ</a></h3>
<p>We can now extend our mission controller to implement our emotion
mirroring game.</p>
<p>To get the recognised facial expression of the current user, we can use
the ROS4HRI tools:</p>
<p>For instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">hri</span> <span class="kn">import</span> <span class="n">HRIListener</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="n">hri_listener</span> <span class="o">=</span> <span class="n">HRIListener</span><span class="p">(</span><span class="s2">&quot;mimic_emotion_hrilistener&quot;</span><span class="p">)</span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="k">for</span> <span class="n">face_id</span><span class="p">,</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">hri_listener</span><span class="o">.</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">6</span>    <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span><span class="p">:</span>
<span class="linenos">7</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Face </span><span class="si">{</span><span class="n">face_id</span><span class="si">}</span><span class="s2"> shows expression </span><span class="si">{</span><span class="n">face</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, we can set the same expression onto the robot face, using the <code class="docutils literal notranslate"><span class="pre">set_expression</span></code> skill:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">rclpy.qos</span> <span class="kn">import</span> <span class="n">QoSProfile</span>
<span class="linenos">2</span><span class="kn">from</span> <span class="nn">interaction_skills.msg</span> <span class="kn">import</span> <span class="n">SetExpression</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="n">expression_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">SetExpression</span><span class="p">,</span> <span class="s2">&quot;/skill/set_expression&quot;</span><span class="p">,</span> <span class="n">QoSProfile</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="n">msg</span> <span class="o">=</span> <span class="n">SetExpression</span><span class="p">()</span>
<span class="linenos">7</span><span class="n">msg</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;happy&quot;</span> <span class="c1"># see Expression.msg for all available expressions</span>
<span class="linenos">8</span><span class="n">expression_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>Modify the mission controller to add a background ‚Äòjob‚Äô of checking for
people‚Äôs face, and accordingly set the robot‚Äôs expression:</p>
<p>Add a <code class="docutils literal notranslate"><span class="pre">run()</span></code> method at the bottom of your mission controller:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking expressions...&quot;</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">faces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hri_listener</span><span class="o">.</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="linenos"> 6</span>    <span class="k">if</span> <span class="n">faces</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="c1"># only consider the first detected face</span>
<span class="linenos"> 8</span>        <span class="n">face_id</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="n">faces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 9</span>        <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span><span class="p">:</span>
<span class="linenos">10</span>                <span class="n">expression</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">11</span>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Face </span><span class="si">{</span><span class="n">face_id</span><span class="si">}</span><span class="s2"> shows expression </span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span>                <span class="n">msg</span> <span class="o">=</span> <span class="n">SetExpression</span><span class="p">()</span>
<span class="linenos">14</span>                <span class="n">msg</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span>
<span class="linenos">15</span>                <span class="bp">self</span><span class="o">.</span><span class="n">expression_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> constructor, create the HRI listener, the
expression publisher, and a timer to regularly call the <code class="docutils literal notranslate"><span class="pre">run()</span></code>
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">rclpy.qos</span> <span class="kn">import</span> <span class="n">QoSProfile</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">interaction_skills.msg</span> <span class="kn">import</span> <span class="n">SetExpression</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="c1"># ...</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="bp">self</span><span class="o">.</span><span class="n">hri_listener</span> <span class="o">=</span> <span class="n">HRIListener</span><span class="p">(</span><span class="s2">&quot;mimic_emotion_hrilistener&quot;</span><span class="p">)</span>
<span class="linenos">10</span>    <span class="bp">self</span><span class="o">.</span><span class="n">expression_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">SetExpression</span><span class="p">,</span> <span class="s2">&quot;/skill/set_expression&quot;</span><span class="p">,</span> <span class="n">QoSProfile</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span> <span class="c1"># check at 10Hz</span>
</pre></div>
</div>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="../../_images/emotion_mirror.jpg"><img alt="The robot detects the 'angry' expression, and mimicks it." src="../../_images/emotion_mirror.jpg" style="width: 70%;" />
</a>
<figcaption>
<p><span class="caption-text">The robot detects the ‚Äòangry‚Äô expression, and mimicks it.</span><a class="headerlink" href="#id10" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p>The final complete script should look like:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">mission_controller.py</span><a class="headerlink" href="#id11" title="Link to this code">ÔÉÅ</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">rclpy.qos</span> <span class="kn">import</span> <span class="n">QoSProfile</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">ActionClient</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kn">from</span> <span class="nn">hri_actions_msgs.msg</span> <span class="kn">import</span> <span class="n">Intent</span>
<span class="linenos"> 8</span><span class="kn">from</span> <span class="nn">interaction_skills.msg</span> <span class="kn">import</span> <span class="n">SetExpression</span>
<span class="linenos"> 9</span><span class="kn">from</span> <span class="nn">communication_skills.action</span> <span class="kn">import</span> <span class="n">Say</span>
<span class="linenos">10</span><span class="kn">from</span> <span class="nn">hri</span> <span class="kn">import</span> <span class="n">HRIListener</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">class</span> <span class="nc">MissionController</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">15</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;app_emotion_mirror&#39;</span><span class="p">)</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising...&quot;</span><span class="p">)</span>
<span class="linenos">18</span>
<span class="linenos">19</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_intents_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
<span class="linenos">20</span>            <span class="n">Intent</span><span class="p">,</span>
<span class="linenos">21</span>            <span class="s1">&#39;/intents&#39;</span><span class="p">,</span>
<span class="linenos">22</span>            <span class="bp">self</span><span class="o">.</span><span class="n">on_intent</span><span class="p">,</span>
<span class="linenos">23</span>            <span class="mi">10</span><span class="p">)</span>
<span class="linenos">24</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Listening to </span><span class="si">%s</span><span class="s2"> topic&quot;</span> <span class="o">%</span>
<span class="linenos">25</span>                               <span class="bp">self</span><span class="o">.</span><span class="n">_intents_sub</span><span class="o">.</span><span class="n">topic_name</span><span class="p">)</span>
<span class="linenos">26</span>
<span class="linenos">27</span>        <span class="bp">self</span><span class="o">.</span><span class="n">hri_listener</span> <span class="o">=</span> <span class="n">HRIListener</span><span class="p">(</span><span class="s2">&quot;mimic_emotion_hrilistener&quot;</span><span class="p">)</span>
<span class="linenos">28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">expression_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">SetExpression</span><span class="p">,</span> <span class="s2">&quot;/skill/set_expression&quot;</span><span class="p">,</span> <span class="n">QoSProfile</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">29</span>        <span class="bp">self</span><span class="o">.</span><span class="n">last_expression</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">30</span>
<span class="linenos">31</span>        <span class="bp">self</span><span class="o">.</span><span class="n">say</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Say</span><span class="p">,</span> <span class="s1">&#39;/skill/say&#39;</span><span class="p">)</span>
<span class="linenos">32</span>        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
<span class="linenos">33</span>
<span class="linenos">34</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span> <span class="c1"># check at 10Hz</span>
<span class="linenos">35</span>
<span class="linenos">36</span>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Destroying Mission Controller&quot;</span><span class="p">)</span>
<span class="linenos">38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_intents_sub</span><span class="p">)</span>
<span class="linenos">39</span>
<span class="linenos">40</span>    <span class="k">def</span> <span class="nf">on_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">41</span>
<span class="linenos">42</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received an intent: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>
<span class="linenos">43</span>
<span class="linenos">44</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="p">{}</span>  <span class="c1"># noqa: F841</span>
<span class="linenos">45</span>        <span class="n">source</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">source</span>  <span class="c1"># noqa: F841</span>
<span class="linenos">46</span>        <span class="n">modality</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">modality</span>  <span class="c1"># noqa: F841</span>
<span class="linenos">47</span>        <span class="n">confidence</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">confidence</span>  <span class="c1"># noqa: F841</span>
<span class="linenos">48</span>        <span class="n">priority_hint</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">priority</span>  <span class="c1"># noqa: F841</span>
<span class="linenos">49</span>
<span class="linenos">50</span>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="n">Intent</span><span class="o">.</span><span class="n">RAW_USER_INPUT</span><span class="p">:</span>
<span class="linenos">51</span>            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing input: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">intent</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">52</span>            <span class="n">goal</span> <span class="o">=</span> <span class="n">Say</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
<span class="linenos">53</span>            <span class="n">goal</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s2">&quot;I&#39;m the famous emotion mirroring robot!&quot;</span>
<span class="linenos">54</span>            <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
<span class="linenos">55</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">56</span>            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know how to process intent &quot;</span>
<span class="linenos">57</span>                                      <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;!&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>
<span class="linenos">58</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">59</span>
<span class="linenos">60</span>        <span class="n">faces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hri_listener</span><span class="o">.</span><span class="n">faces</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="linenos">61</span>        <span class="k">if</span> <span class="n">faces</span><span class="p">:</span>
<span class="linenos">62</span>            <span class="c1"># only consider the first detected face</span>
<span class="linenos">63</span>            <span class="n">face_id</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="n">faces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">64</span>            <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span> <span class="ow">and</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_expression</span><span class="p">:</span>
<span class="linenos">65</span>                    <span class="n">expression</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">66</span>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Face </span><span class="si">{</span><span class="n">face_id</span><span class="si">}</span><span class="s2"> shows expression </span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">67</span>
<span class="linenos">68</span>                    <span class="n">goal</span> <span class="o">=</span> <span class="n">Say</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
<span class="linenos">69</span>                    <span class="n">goal</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;you look </span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2">. Same for me!&quot;</span>
<span class="linenos">70</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
<span class="linenos">71</span>
<span class="linenos">72</span>                    <span class="n">msg</span> <span class="o">=</span> <span class="n">SetExpression</span><span class="p">()</span>
<span class="linenos">73</span>                    <span class="n">msg</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span>
<span class="linenos">74</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">expression_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">75</span>
<span class="linenos">76</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">last_expression</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">expression</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="part-4-integration-with-llms">
<h2>PART 4: Integration with LLMs<a class="headerlink" href="#part-4-integration-with-llms" title="Link to this heading">ÔÉÅ</a></h2>
<section id="adding-a-chatbot">
<h3>Adding a chatbot<a class="headerlink" href="#adding-a-chatbot" title="Link to this heading">ÔÉÅ</a></h3>
<section id="step-1-creating-a-chatbot">
<h4>Step 1: creating a chatbot<a class="headerlink" href="#step-1-creating-a-chatbot" title="Link to this heading">ÔÉÅ</a></h4>
<ol class="arabic simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">rpk</span></code> to create a new <code class="docutils literal notranslate"><span class="pre">chatbot</span></code> skill using the <em>basic
chabot</em> intent extraction template:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>rpk<span class="w"> </span>create<span class="w"> </span>-p<span class="w"> </span>src<span class="w"> </span>intent
ID<span class="w"> </span>of<span class="w"> </span>your<span class="w"> </span>application?<span class="w"> </span><span class="o">(</span>must<span class="w"> </span>be<span class="w"> </span>a<span class="w"> </span>valid<span class="w"> </span>ROS<span class="w"> </span>identifier<span class="w"> </span>without<span class="w"> </span>spaces<span class="w"> </span>or<span class="w"> </span>hyphens.<span class="w"> </span>eg<span class="w"> </span><span class="s1">&#39;robot_receptionist&#39;</span><span class="o">)</span>
chatbot
Full<span class="w"> </span>name<span class="w"> </span>of<span class="w"> </span>your<span class="w"> </span>skill/application?<span class="w"> </span><span class="o">(</span>eg<span class="w"> </span><span class="s1">&#39;The Receptionist Robot&#39;</span><span class="w"> </span>or<span class="w"> </span><span class="s1">&#39;Database connector&#39;</span>,<span class="w"> </span>press<span class="w"> </span>Return<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span>ID.<span class="w"> </span>You<span class="w"> </span>can<span class="w"> </span>change<span class="w"> </span>it<span class="w"> </span>later<span class="o">)</span>


Choose<span class="w"> </span>a<span class="w"> </span>template:
<span class="m">1</span>:<span class="w"> </span>basic<span class="w"> </span>chatbot<span class="w"> </span>template<span class="w"> </span><span class="o">[</span>python<span class="o">]</span>
<span class="m">2</span>:<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>intent<span class="w"> </span>extraction<span class="w"> </span>example:<span class="w"> </span>LLM<span class="w"> </span>bridge<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span>OpenAI<span class="w"> </span>API<span class="w"> </span><span class="o">(</span>ollama,<span class="w"> </span>chatgpt<span class="o">)</span><span class="w"> </span><span class="o">[</span>python<span class="o">]</span>

Your<span class="w"> </span>choice?<span class="w"> </span><span class="m">1</span>

What<span class="w"> </span>robot<span class="w"> </span>are<span class="w"> </span>you<span class="w"> </span>targeting?
<span class="m">1</span>:<span class="w"> </span>Generic<span class="w"> </span>robot<span class="w"> </span><span class="o">(</span>generic<span class="o">)</span>
<span class="m">2</span>:<span class="w"> </span>Generic<span class="w"> </span>PAL<span class="w"> </span>robot/simulator<span class="w"> </span><span class="o">(</span>generic-pal<span class="o">)</span>
<span class="m">3</span>:<span class="w"> </span>PAL<span class="w"> </span>ARI<span class="w"> </span><span class="o">(</span>ari<span class="o">)</span>
<span class="m">4</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span><span class="o">(</span>tiago<span class="o">)</span>
<span class="m">5</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span>Pro<span class="w"> </span><span class="o">(</span>tiago-pro<span class="o">)</span>
<span class="m">6</span>:<span class="w"> </span>PAL<span class="w"> </span>TIAGo<span class="w"> </span>Head<span class="w"> </span><span class="o">(</span>tiago-head<span class="o">)</span>

Your<span class="w"> </span>choice?<span class="w"> </span><span class="o">(</span>default:<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>generic<span class="o">)</span><span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<p>Compile the chatbot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>colcon<span class="w"> </span>build
<span class="nb">source</span><span class="w"> </span>install/setup.bash
</pre></div>
</div>
<p>Then, start your chatbot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>chatbot<span class="w"> </span>chatbot.launch.py
</pre></div>
</div>
<p>If you now type a message in the <code class="docutils literal notranslate"><span class="pre">rqt_chat</span></code> plugin, you should see
the chatbot responding to it:</p>
<figure class="align-default" id="id12" style="width: 400px">
<a class="reference internal image-reference" href="../../_images/chatbot_tpl.png"><img alt="Chatbot responding to a message" src="../../_images/chatbot_tpl.png" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-text">Chatbot responding to a message</span><a class="headerlink" href="#id12" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p>If you tick the checkbox at the bottom, you can also see in the chat window the
<em>intents</em> that the chatbot has identified in the user input. For now, our basic
chatbot only recognises the <code class="docutils literal notranslate"><span class="pre">__intent_greet__</span></code> intent when you type <code class="docutils literal notranslate"><span class="pre">Hi</span></code> or
<code class="docutils literal notranslate"><span class="pre">Hello</span></code>.</p>
</section>
<section id="step-2-integrating-the-chatbot-with-the-mission-controller">
<h4>Step 2: integrating the chatbot with the mission controller<a class="headerlink" href="#step-2-integrating-the-chatbot-with-the-mission-controller" title="Link to this heading">ÔÉÅ</a></h4>
<p>To fully understand the intent pipeline, we will modify the chatbot to
recognise a ‚Äòpick up‚Äô intent, and the mission controller to handle it.</p>
<ul class="simple">
<li><p>open <code class="docutils literal notranslate"><span class="pre">chatbot/node_impl.py</span></code> and modify your chatbot to check whether
incoming speech matches <code class="docutils literal notranslate"><span class="pre">[please]</span> <span class="pre">pick</span> <span class="pre">up</span> <span class="pre">[the]</span> <span class="pre">&lt;object&gt;</span></code>:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">re</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">class</span> <span class="nc">BasicChatbot</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="c1"># [...]</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="k">def</span> <span class="nf">contains_pickup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
<span class="linenos"> 8</span>        <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>        <span class="c1"># matches sentences like: [please] pick up [the] &lt;object&gt; and return &lt;object&gt;</span>
<span class="linenos">11</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:please\s+)?pick\s+up\s+(?:the\s+)?(\w+)&quot;</span>
<span class="linenos">12</span>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span>
<span class="linenos">13</span>        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<span class="linenos">14</span>            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>then, in the <code class="docutils literal notranslate"><span class="pre">on_dialogue_interaction</span></code> method, check if the incoming
speech matches the pattern, and if so, return a
<code class="docutils literal notranslate"><span class="pre">__intent_grab_object__</span></code>:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">on_dialogue_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="c1">#...</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">pick_up_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_pickup</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="k">if</span> <span class="n">pick_up_object</span><span class="p">:</span>
<span class="linenos"> 8</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I think the user want to pick up a </span><span class="si">{</span><span class="n">pick_up_object</span><span class="si">}</span><span class="s2">. Sending a GRAB_OBJECT intent&quot;</span><span class="p">)</span>
<span class="linenos"> 9</span>        <span class="n">intents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="n">Intent</span><span class="o">.</span><span class="n">GRAB_OBJECT</span><span class="p">,</span>
<span class="linenos">10</span>                              <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">pick_up_object</span><span class="p">}),</span>
<span class="linenos">11</span>                              <span class="n">source</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<span class="linenos">12</span>                              <span class="n">modality</span><span class="o">=</span><span class="n">Intent</span><span class="o">.</span><span class="n">MODALITY_SPEECH</span><span class="p">,</span>
<span class="linenos">13</span>                              <span class="n">confidence</span><span class="o">=</span><span class="mf">.8</span><span class="p">))</span>
<span class="linenos">14</span>        <span class="n">suggested_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sure, let me pick up this </span><span class="si">{</span><span class="n">pick_up_object</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">15</span>
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="c1"># elif ...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the <code class="docutils literal notranslate"><span class="pre">Intent</span></code> message is defined in the <code class="docutils literal notranslate"><span class="pre">hri_actions_msgs</span></code>
package, and contains the intent, the data associated with the
intent, the source of the intent (here, the current <code class="docutils literal notranslate"><span class="pre">user_id</span></code>), the
modality (here, <code class="docutils literal notranslate"><span class="pre">speech</span></code>), and the confidence of the recognition.</p>
<p>Check the <a class="reference external" href="https://docs.pal-robotics.com/edge/development/intents">Intents documentation on PAL
website</a>
for details, or directly the
<a class="reference external" href="https://github.com/ros4hri/hri_actions_msgs/blob/humble-devel/msg/Intent.msg">Intent.msg</a>
definition.</p>
</div>
<p>Test your updated chatbot by recompiling the workspace
(<code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span></code>) and relaunching the chatbot.</p>
<p>If you now type <code class="docutils literal notranslate"><span class="pre">pick</span> <span class="pre">up</span> <span class="pre">the</span> <span class="pre">cup</span></code> in the chat window, you should see
the chatbot recognising the intent and sending a <code class="docutils literal notranslate"><span class="pre">GRAB_OBJECT</span></code> intent
to the mission controller.</p>
<ul>
<li><p>finally, modify the mission controller function handling inbound
intents, in order to manage the <code class="docutils literal notranslate"><span class="pre">GRAB_OBJECT</span></code> intent. Open
<code class="docutils literal notranslate"><span class="pre">emotion_mirror/mission_controller.py</span></code> and modify the <code class="docutils literal notranslate"><span class="pre">on_intent</span></code>
method to handle the <code class="docutils literal notranslate"><span class="pre">GRAB_OBJECT</span></code> intent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">on_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="c1">#...</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="n">Intent</span><span class="o">.</span><span class="n">GRAB_OBJECT</span><span class="p">:</span>
<span class="linenos"> 5</span>        <span class="c1"># on a real robot, you would call here a manipulation skill</span>
<span class="linenos"> 6</span>        <span class="n">goal</span> <span class="o">=</span> <span class="n">Say</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
<span class="linenos"> 7</span>        <span class="n">goal</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;set expression(tired)&gt; That </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is really heavy...! &lt;set expression(neutral)&gt;&quot;</span>
<span class="linenos"> 8</span>        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="c1"># ...</span>
</pre></div>
</div>
</li>
</ul>
<p>Re-compile and re-run the mission controller. If you now type
<code class="docutils literal notranslate"><span class="pre">pick</span> <span class="pre">up</span> <span class="pre">the</span> <span class="pre">cup</span></code> in the chat window, you should see the mission
controller reacting to it.</p>
<div class="admonition-learn-more admonition">
<p class="admonition-title">üìö Learn more</p>
<p>In this example, we directly use the <code class="docutils literal notranslate"><span class="pre">/skill/say</span></code> skill to respond to the
user.</p>
<p>When developing a full application, you usually want to split your
architecture into multiple nodes, each responsible for a specific
task.</p>
<p>The ROS4HRI application model, based on the RobMoSys methodology,
encourages the development of a <strong>single</strong> <em>mission controller</em>, and
a series of <em>tasks</em> and <em>skills</em> that are orchestrated by the mission
controller.</p>
<p>You can read more about this model on the <a class="reference external" href="https://docs.pal-robotics.com/edge/development/intro-development">PAL documentation
website</a>.</p>
</div>
</section>
</section>
<section id="integrating-with-a-large-language-model-llm">
<h3>Integrating with a Large Language Model (LLM)<a class="headerlink" href="#integrating-with-a-large-language-model-llm" title="Link to this heading">ÔÉÅ</a></h3>
<p>Next, let‚Äôs integrate with an LLM.</p>
<section id="step-1-install-ollama">
<h4>Step 1: install <code class="docutils literal notranslate"><span class="pre">ollama</span></code><a class="headerlink" href="#step-1-install-ollama" title="Link to this heading">ÔÉÅ</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">ollama</span></code> is an open-source tool that provides a simple REST API to
interact with a variety of LLMs. It makes it easy to install different
LLMs, and to call them using the same REST API as, eg, OpenAI‚Äôs ChatGPT.</p>
<p>To install <code class="docutils literal notranslate"><span class="pre">ollama</span></code> on your machine, follow the instructions on the
<a class="reference external" href="https://ollama.com/download">official repository</a>:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For convenience, we recommend to install <code class="docutils literal notranslate"><span class="pre">ollama</span></code> outside of your Docker
environment, on your host machine directly.</p>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://ollama.com/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</pre></div>
</div>
<p>Once it is installed, you can start the <code class="docutils literal notranslate"><span class="pre">ollama</span></code> server with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ollama<span class="w"> </span>serve
</pre></div>
</div>
<p>Open a new terminal, and run the following command to download a
first model and check it works:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ollama<span class="w"> </span>run<span class="w"> </span>gemma3:1b
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Visit the <a class="reference external" href="https://ollama.com/search">ollama model page</a> to
see the list of available models.</p>
<p>Depending on the size of the model and your computer configuration,
the response time can be quite long.</p>
<p>Having a fast GPU helps :-)</p>
</div>
</section>
<section id="step-2-calling-ollama-from-the-chatbot">
<h4>Step 2: calling <code class="docutils literal notranslate"><span class="pre">ollama</span></code> from the chatbot<a class="headerlink" href="#step-2-calling-ollama-from-the-chatbot" title="Link to this heading">ÔÉÅ</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">ollama</span></code> can be accessed from your code either by calling the REST API
directly, or by using the <code class="docutils literal notranslate"><span class="pre">ollama</span></code> Python binding. While the REST API
is more flexible (and makes it possible to easily use other
OpenAI-compatible services, like ChatGPT), the Python binding is very
easy to use.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are curious about the REST API, use <code class="docutils literal notranslate"><span class="pre">rpk</span></code> LLM chatbot
template to generate an example of a chatbot that calls <code class="docutils literal notranslate"><span class="pre">ollama</span></code>
via the REST API.</p>
</div>
<ul>
<li><p>install the <code class="docutils literal notranslate"><span class="pre">ollama</span></code> python binding inside your Docker image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>ollama
</pre></div>
</div>
</li>
<li><p>Modify your chatbot to connect to <code class="docutils literal notranslate"><span class="pre">ollama</span></code>, using a custom prompt.
Open <code class="docutils literal notranslate"><span class="pre">chatbot/chatbot/node_impl.py</span></code> do the following changes:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># add to the imports</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">ollama</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1"># ...</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">class</span> <span class="nc">BasicChatbot</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>    <span class="c1"># modify the constructor:</span>
<span class="linenos"> 9</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="c1"># ...</span>
<span class="linenos">11</span>
<span class="linenos">12</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_ollama_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="linenos">13</span>        <span class="c1"># if ollama does not run on the local host, you can specify the host and</span>
<span class="linenos">14</span>        <span class="c1"># port. For instance:</span>
<span class="linenos">15</span>        <span class="c1"># self._ollama_client = Client(&quot;x.x.x.x:11434&quot;)</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="c1"># dialogue history</span>
<span class="linenos">18</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">19</span>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
<span class="linenos">20</span>             <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="linenos">21</span><span class="s2">                You are a helpful robot, always eager to help.</span>
<span class="linenos">22</span><span class="s2">                You always respond with concise and to-the-point answers.</span>
<span class="linenos">23</span><span class="s2">             &quot;&quot;&quot;</span>
<span class="linenos">24</span>             <span class="p">}]</span>
<span class="linenos">25</span>
<span class="linenos">26</span>    <span class="c1"># ...</span>
<span class="linenos">27</span>
<span class="linenos">28</span>    <span class="c1"># modify on_dialogue_interaction:</span>
<span class="linenos">29</span>    <span class="k">def</span> <span class="nf">on_dialogue_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="linenos">30</span>                             <span class="n">request</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<span class="linenos">31</span>                             <span class="n">response</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="linenos">32</span>
<span class="linenos">33</span>        <span class="c1"># we can have multiple dialogues: we use the dialogue_id to</span>
<span class="linenos">34</span>        <span class="c1"># identify to which conversation this new input belongs</span>
<span class="linenos">35</span>        <span class="n">target_dialogue_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dialogue_id</span>
<span class="linenos">36</span>
<span class="linenos">37</span>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span>
<span class="linenos">38</span>        <span class="nb">input</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">input</span>
<span class="linenos">39</span>
<span class="linenos">40</span>        <span class="c1"># response_expected might be False if, for instance, the robot</span>
<span class="linenos">41</span>        <span class="c1"># itself is saying something. It might be useful to add it to</span>
<span class="linenos">42</span>        <span class="c1"># the dialogue history with the user, but we do not need to</span>
<span class="linenos">43</span>        <span class="c1"># generate a response.</span>
<span class="linenos">44</span>        <span class="n">response_expected</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">response_expected</span>
<span class="linenos">45</span>        <span class="n">suggested_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">46</span>        <span class="n">intents</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">47</span>
<span class="linenos">48</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input from </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> to dialogue </span><span class="si">{</span><span class="n">target_dialogue_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">49</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">50</span>
<span class="linenos">51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})</span>
<span class="linenos">52</span>
<span class="linenos">53</span>        <span class="n">llm_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ollama_client</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<span class="linenos">54</span>            <span class="n">messages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
<span class="linenos">55</span>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemma3:1b&quot;</span>
<span class="linenos">56</span>        <span class="p">)</span>
<span class="linenos">57</span>
<span class="linenos">58</span>        <span class="n">content</span> <span class="o">=</span> <span class="n">llm_res</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
<span class="linenos">59</span>
<span class="linenos">60</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The LLM answered: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">61</span>
<span class="linenos">62</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
<span class="linenos">63</span>
<span class="linenos">64</span>        <span class="n">response</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">content</span>
<span class="linenos">65</span>        <span class="n">response</span><span class="o">.</span><span class="n">intents</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">66</span>        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>As you can see, calling <code class="docutils literal notranslate"><span class="pre">ollama</span></code> is as simple as creating a <code class="docutils literal notranslate"><span class="pre">Client</span></code>
object and calling its <code class="docutils literal notranslate"><span class="pre">chat</span></code> method with the messages to send to the
LLM and the model to use.</p>
<p>In this example, we append to the chat history (<code class="docutils literal notranslate"><span class="pre">self.messages</span></code>) the
user input and the LLM response after each interaction, thus building a
complete dialogue.</p>
<p>Recompile and restart the chatbot. If you now type a message in the chat
window, you should see the chatbot responding with a text generated by
the LLM:</p>
<figure class="align-default" id="id13" style="width: 341px">
<a class="reference internal image-reference" href="../../_images/chat_llm.png"><img alt="Example of a chatbot response generated by an LLM (in this example, Phi4)" src="../../_images/chat_llm.png" style="width: 341px;" />
</a>
<figcaption>
<p><span class="caption-text">Example of a chatbot response generated by an LLM (in this example, Phi4)</span><a class="headerlink" href="#id13" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Depending on the LLM model you use, the response time can be quite
long. By default, after 10s, <code class="docutils literal notranslate"><span class="pre">communication_hub</span></code> will time out. In that
case, the chatbot answer will not be displayed in the chat window.</p>
</div>
</section>
<section id="step-3-extract-user-intents">
<h4>Step 3: extract user intents<a class="headerlink" href="#step-3-extract-user-intents" title="Link to this heading">ÔÉÅ</a></h4>
<p>To recognise intents from the LLM response, we can use a combination of
prompt engineering and LLM structured output.</p>
<ul class="simple">
<li><p>to generate structured output (ie, a JSON-structured response that
includes the recognised intents), we first need to write a Python
object that corresponds to the expected output of the LLM:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">hri_actions_msgs.msg</span> <span class="kn">import</span> <span class="n">Intent</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1"># Define the data models for the chatbot response and the user intent</span>
<span class="linenos"> 6</span><span class="k">class</span> <span class="nc">IntentModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">Intent</span><span class="o">.</span><span class="n">BRING_OBJECT</span><span class="p">,</span>
<span class="linenos"> 8</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GRAB_OBJECT</span><span class="p">,</span>
<span class="linenos"> 9</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">PLACE_OBJECT</span><span class="p">,</span>
<span class="linenos">10</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GUIDE</span><span class="p">,</span>
<span class="linenos">11</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">MOVE_TO</span><span class="p">,</span>
<span class="linenos">12</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">SAY</span><span class="p">,</span>
<span class="linenos">13</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GREET</span><span class="p">,</span>
<span class="linenos">14</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">START_ACTIVITY</span><span class="p">,</span>
<span class="linenos">15</span>                  <span class="p">]</span>
<span class="linenos">16</span>    <span class="nb">object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">17</span>    <span class="n">recipient</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">18</span>    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">19</span>    <span class="n">goal</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="k">class</span> <span class="nc">ChatbotResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos">22</span>    <span class="n">verbal_ack</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">23</span>    <span class="n">user_intent</span><span class="p">:</span> <span class="n">IntentModel</span> <span class="o">|</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Here, we use the type <code class="docutils literal notranslate"><span class="pre">BaseModel</span></code> from the <code class="docutils literal notranslate"><span class="pre">pydantic</span></code> library so
that we can generate the formal model corresponding to this Python
object (using the JSON schema specification).</p>
<ul class="simple">
<li><p>then, modify the chatbot to force the LLM to return a JSON-structured
response that includes the recognised intents:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>    <span class="c1"># ...</span>
<span class="linenos"> 2</span>    <span class="k">def</span> <span class="nf">on_dialogue_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 3</span>                             <span class="n">request</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<span class="linenos"> 4</span>                             <span class="n">response</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>        <span class="n">target_dialogue_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dialogue_id</span>
<span class="linenos"> 7</span>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span>
<span class="linenos"> 8</span>        <span class="nb">input</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">input</span>
<span class="linenos"> 9</span>        <span class="n">response_expected</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">response_expected</span>
<span class="linenos">10</span>        <span class="n">suggested_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">11</span>        <span class="n">intents</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">12</span>
<span class="linenos">13</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input from </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> to dialogue </span><span class="si">{</span><span class="n">target_dialogue_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">15</span>
<span class="linenos">16</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})</span>
<span class="linenos">17</span>
<span class="linenos">18</span>        <span class="n">llm_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ollama_client</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<span class="linenos">19</span>            <span class="n">messages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
<span class="linenos">20</span>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemma3:1b&quot;</span><span class="p">,</span>
<span class="linenos">21</span>            <span class="nb">format</span><span class="o">=</span><span class="n">ChatbotResponse</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span> <span class="c1"># &lt;- the magic happens here</span>
<span class="linenos">22</span>        <span class="p">)</span>
<span class="linenos">23</span>
<span class="linenos">24</span>        <span class="n">json_res</span> <span class="o">=</span> <span class="n">ChatbotResponse</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">llm_res</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="linenos">25</span>
<span class="linenos">26</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The LLM answered: </span><span class="si">{</span><span class="n">json_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">27</span>
<span class="linenos">28</span>        <span class="n">verbal_ack</span> <span class="o">=</span> <span class="n">json_res</span><span class="o">.</span><span class="n">verbal_ack</span>
<span class="linenos">29</span>        <span class="k">if</span> <span class="n">verbal_ack</span><span class="p">:</span>
<span class="linenos">30</span>            <span class="c1"># if we have a verbal acknowledgement, add it to the dialogue history,</span>
<span class="linenos">31</span>            <span class="c1"># and send it to the user</span>
<span class="linenos">32</span>            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">verbal_ack</span><span class="p">})</span>
<span class="linenos">33</span>            <span class="n">response</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">verbal_ack</span>
<span class="linenos">34</span>
<span class="linenos">35</span>        <span class="n">user_intent</span> <span class="o">=</span> <span class="n">json_res</span><span class="o">.</span><span class="n">user_intent</span>
<span class="linenos">36</span>        <span class="k">if</span> <span class="n">user_intent</span><span class="p">:</span>
<span class="linenos">37</span>            <span class="n">response</span><span class="o">.</span><span class="n">intents</span> <span class="o">=</span> <span class="p">[</span><span class="n">Intent</span><span class="p">(</span>
<span class="linenos">38</span>                <span class="n">intent</span><span class="o">=</span><span class="n">user_intent</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="linenos">39</span>                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">user_intent</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
<span class="linenos">40</span>            <span class="p">)]</span>
<span class="linenos">41</span>
<span class="linenos">42</span>        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>Now, the LLM will always return a JSON-structured response that includes
an intent (if one was recognised), and a verbal acknowledgement. For
instance, when asking the robot to <code class="docutils literal notranslate"><span class="pre">bring</span> <span class="pre">an</span> <span class="pre">apple</span></code>, it returns an
intent <code class="docutils literal notranslate"><span class="pre">PLACE_OBJECT</span></code> with the object <code class="docutils literal notranslate"><span class="pre">apple</span></code>:</p>
<figure class="align-default" id="id14" style="width: 400px">
<a class="reference internal image-reference" href="../../_images/chat_llm_intents.png"><img alt="Example of a structured LLM response" src="../../_images/chat_llm_intents.png" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-text">Example of a structured LLM response</span><a class="headerlink" href="#id14" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</section>
<section id="step-4-prompt-engineering-to-improve-intent-recognition">
<h4>Step 4: prompt engineering to improve intent recognition<a class="headerlink" href="#step-4-prompt-engineering-to-improve-intent-recognition" title="Link to this heading">ÔÉÅ</a></h4>
<p>To improve the intent recognition, we can use <em>prompt engineering</em>: we
can provide the LLM with a prompt that will guide it towards generating
a response that includes the intents we are interested in.</p>
<p>One key trick is to provide the LLM with examples of the intents we are
interested in.</p>
<p>Here an example of a longer prompt, that would yield better results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are a friendly robot called $robot_name. You try to help the user to the best of your abilities.</span>
<span class="s2">You are always helpful, and ask further questions if the desires of the user are unclear.</span>
<span class="s2">Your answers are always polite yet concise and to-the-point.</span>

<span class="s2">Your aim is to extract the user goal.</span>

<span class="s2">Your response must be a JSON object with the following fields (both are optional):</span>
<span class="s2">- verbal_ack: a string acknowledging the user request (like &#39;Sure&#39;, &#39;I&#39;m on it&#39;...)</span>
<span class="s2">- user_intent: the user overall goal (intent), with the following fields:</span>
<span class="s2">  - type: the type of intent to perform (e.g. &quot;__intent_say__&quot;, &quot;__intent_greet__&quot;, &quot;__intent_start_activity__&quot;, etc.)</span>
<span class="s2">  - any thematic role required by the intent. For instance: `object` to</span>
<span class="s2">    relate the intent to the object to interact with (e.g. &quot;lamp&quot;,</span>
<span class="s2">    &quot;door&quot;, etc.)</span>

<span class="s2">Importantly, `verbal_ack` is meant to be a *short* acknowledgement sentence,</span>
<span class="s2">unconditionally uttered by the robot, indicating that you have understood the request -- or that we need more information.</span>
<span class="s2">For more complex verbal actions, return a `__intent_say__` instead.</span>

<span class="s2">However, for answers to general questions that do not require any action</span>
<span class="s2">(eg: &#39;what is your name?&#39;), the &#39;user_intent&#39; field can be omitted, and the</span>
<span class="s2">&#39;verbal_ack&#39; field should contain the answer.</span>

<span class="s2">The user_id of the person you are talking to is $user_id. Always use this ID when referring to the person in your responses.</span>

<span class="s2">Examples</span>
<span class="s2">- if the user says &#39;Hello robot&#39;, you could respond:</span>
<span class="s2">{</span>
<span class="s2">    &quot;user_intent&quot;: {&quot;type&quot;: &quot;__intent_greet__&quot;, &quot;recipient&quot;: &quot;$user_id&quot;}</span>
<span class="s2">}</span>

<span class="s2">- if the user says &#39;What is your name?&#39;, you could respond:</span>
<span class="s2">{</span>
<span class="s2">    &quot;verbal_ack&quot;:&quot;My name is $robot_name. What is your name?&quot;</span>
<span class="s2">}</span>

<span class="s2">- if the user say &#39;take a fruit&#39;, you could respond (assuming a object &#39;apple1&#39; of type &#39;Apple&#39; is visible):</span>
<span class="s2">{</span>
<span class="s2">    &quot;user_intent&quot;: {</span>
<span class="s2">            &quot;type&quot;:&quot;__intent_grab_object__&quot;,</span>
<span class="s2">            &quot;object&quot;:&quot;apple1&quot;,</span>
<span class="s2">    },</span>
<span class="s2">    &quot;verbal_ack&quot;: &quot;Sure&quot;</span>
<span class="s2">}</span>

<span class="s2">- if the user say &#39;take a fruit&#39;, but you do not know about any fruit. You could respond:</span>
<span class="s2">{</span>
<span class="s2">    &quot;verbal_ack&quot;: &quot;I haven&#39;t seen any fruits around. Do you want me to check in the kitchen?&quot;</span>
<span class="s2">}</span>

<span class="s2">- the user says: &#39;clean the table&#39;. You could return:</span>
<span class="s2">{</span>
<span class="s2">    &quot;user_intent&quot;: {</span>
<span class="s2">        &quot;type&quot;:&quot;__intent_start_activity__&quot;,</span>
<span class="s2">        &quot;object&quot;: &quot;cleaning_table&quot;</span>
<span class="s2">    },</span>
<span class="s2">    &quot;verbal_ack&quot;: &quot;Sure, I&#39;ll get started&quot;</span>
<span class="s2">}</span>

<span class="s2">If you are not sure about the intention of the user, return an empty user_intent and ask for confirmation with the verbal_ack field.</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This prompt uses Python‚Äôs templating system to include the robot‚Äôs name
and the user‚Äôs ID in the prompt.</p>
<p>You can use this prompt in your script by <em>substituting</em> the variables
with the actual values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">actual_prompt</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">PROMPT</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">robot_name</span><span class="o">=</span><span class="s2">&quot;Robbie&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;Alice&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, you can use this prompt in the <code class="docutils literal notranslate"><span class="pre">ollama</span></code> call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">__init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="c1"># ...</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span><span class="n">PROMPT</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">robot_name</span><span class="o">=</span><span class="s2">&quot;Robbie&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user1&quot;</span><span class="p">)</span>
            <span class="p">}]</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="closing-the-loop-integrating-llm-and-symbolic-knowledge-representation">
<h4>Closing the loop: integrating LLM and symbolic knowledge representation<a class="headerlink" href="#closing-the-loop-integrating-llm-and-symbolic-knowledge-representation" title="Link to this heading">ÔÉÅ</a></h4>
<p>Finally, we can use the knowledge base to improve the intent
recognition.</p>
<p>For instance, if the user asks the robot to <code class="docutils literal notranslate"><span class="pre">bring</span> <span class="pre">the</span> <span class="pre">apple</span></code>, we can
use the knowledge base to check whether an apple is in the field of view
of the robot.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is often convenient to have a Python interpreter open to
quickly test knowledge base queries.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">ipython3</span></code> in a terminal from within your Docker image, and
then:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">knowledge_core.api</span> <span class="kn">import</span> <span class="n">KB</span><span class="p">;</span> <span class="n">kb</span> <span class="o">=</span> <span class="n">KB</span><span class="p">()</span>
<span class="n">kb</span><span class="p">[</span><span class="s2">&quot;* sees *&quot;</span><span class="p">]</span> <span class="c1"># etc.</span>
</pre></div>
</div>
</div>
<p>First, let‚Äôs query the knowledge base for all the objects that are
visible to the robot:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">knowledge_core.api</span> <span class="kn">import</span> <span class="n">KB</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1"># ...</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="c1"># ...</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">KB</span><span class="p">()</span>
<span class="linenos">10</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; fetch all the objects and humans visible to the robot,</span>
<span class="linenos">14</span><span class="sd">    get for each of them their class and label, and return a string</span>
<span class="linenos">15</span><span class="sd">    that list them all.</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="sd">    A more advanced version could also include the position of the objects</span>
<span class="linenos">18</span><span class="sd">    and spatial relations between them.</span>
<span class="linenos">19</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">20</span>
<span class="linenos">21</span>    <span class="n">environment_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="n">seen_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="p">[</span><span class="s2">&quot;myself sees ?obj&quot;</span><span class="p">]</span>
<span class="linenos">24</span>    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seen_objects</span><span class="p">]:</span>
<span class="linenos">25</span>        <span class="n">details</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">details</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">26</span>        <span class="n">label</span><span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
<span class="linenos">27</span>        <span class="n">classes</span><span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
<span class="linenos">28</span>        <span class="n">class_name</span><span class="o">=</span> <span class="kc">None</span>
<span class="linenos">29</span>        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
<span class="linenos">30</span>                <span class="n">class_name</span><span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
<span class="linenos">31</span>                <span class="n">environment_description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- I see a </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2"> labeled </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="linenos">32</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">33</span>            <span class="n">environment_description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- I see </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="linenos">34</span>
<span class="linenos">35</span>    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="linenos">36</span>        <span class="sa">f</span><span class="s2">&quot;Environment description:</span><span class="se">\n</span><span class="si">{</span><span class="n">environment_description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">37</span>    <span class="k">return</span> <span class="n">environment_description</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kb.details</span></code> method returns a dictionary with details about
a given knowledge concept. The <code class="docutils literal notranslate"><span class="pre">attributes</span></code> field contains e.g.¬†the
class of the object (if known or inferred by the knowledg base).</p>
</div>
<div class="admonition-learn-more admonition">
<p class="admonition-title">üìö Learn more</p>
<p>To inspect in details the knowledge base, we recommend using
<a class="reference external" href="https://protege.stanford.edu/">Prot√©g√©</a>, an open-source tool to
explore and modify ontologies.</p>
<p>The ontology used by the robot (and the interaction simulator) is
stored in <code class="docutils literal notranslate"><span class="pre">/opt/pal/alum/share/oro/ontologies/oro.owl</span></code>. Copy this
file to your <code class="docutils literal notranslate"><span class="pre">~/exchange</span></code> folder to access it from your host and
inspect it with Prot√©g√©.</p>
</div>
<p>We can then use this information to ground the user intents in the
physical world of the robot.</p>
<p>Add an environment update before each calls to the LLM:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">on_dialogue_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 2</span>                            <span class="n">request</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<span class="linenos"> 3</span>                            <span class="n">response</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="c1"># ...</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">()})</span>
<span class="linenos"> 8</span>    <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Re-compile and restart your chatbot. You can now ask the robot e.g.¬†what
it sees.</p>
<p>The final chatbot code should look like:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">chatbot/node_impl.py</span><a class="headerlink" href="#id15" title="Link to this code">ÔÉÅ</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos">  2</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos">  3</span><span class="kn">from</span> <span class="nn">ollama</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="kn">from</span> <span class="nn">knowledge_core.api</span> <span class="kn">import</span> <span class="n">KB</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="linenos">  8</span><span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">State</span>
<span class="linenos">  9</span><span class="kn">from</span> <span class="nn">rclpy.lifecycle</span> <span class="kn">import</span> <span class="n">TransitionCallbackReturn</span>
<span class="linenos"> 10</span><span class="kn">from</span> <span class="nn">rcl_interfaces.msg</span> <span class="kn">import</span> <span class="n">ParameterDescriptor</span>
<span class="linenos"> 11</span><span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">ActionServer</span><span class="p">,</span> <span class="n">GoalResponse</span>
<span class="linenos"> 12</span><span class="kn">from</span> <span class="nn">hri_actions_msgs.msg</span> <span class="kn">import</span> <span class="n">Intent</span>
<span class="linenos"> 13</span><span class="kn">from</span> <span class="nn">i18n_msgs.action</span> <span class="kn">import</span> <span class="n">SetLocale</span>
<span class="linenos"> 14</span><span class="kn">from</span> <span class="nn">i18n_msgs.srv</span> <span class="kn">import</span> <span class="n">GetLocales</span>
<span class="linenos"> 15</span><span class="kn">from</span> <span class="nn">diagnostic_msgs.msg</span> <span class="kn">import</span> <span class="n">DiagnosticArray</span><span class="p">,</span> <span class="n">DiagnosticStatus</span><span class="p">,</span> <span class="n">KeyValue</span>
<span class="linenos"> 16</span><span class="kn">from</span> <span class="nn">chatbot_msgs.action</span> <span class="kn">import</span> <span class="n">Dialogue</span>
<span class="linenos"> 17</span><span class="kn">from</span> <span class="nn">chatbot_msgs.srv</span> <span class="kn">import</span> <span class="n">DialogueInteraction</span>
<span class="linenos"> 18</span><span class="kn">from</span> <span class="nn">rclpy.action</span> <span class="kn">import</span> <span class="n">CancelResponse</span>
<span class="linenos"> 19</span><span class="kn">from</span> <span class="nn">rclpy.action.server</span> <span class="kn">import</span> <span class="n">ServerGoalHandle</span>
<span class="linenos"> 20</span><span class="kn">from</span> <span class="nn">rclpy.callback_groups</span> <span class="kn">import</span> <span class="n">ReentrantCallbackGroup</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="linenos"> 23</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="linenos"> 24</span><span class="kn">from</span> <span class="nn">hri_actions_msgs.msg</span> <span class="kn">import</span> <span class="n">Intent</span>
<span class="linenos"> 25</span><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="n">PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 28</span><span class="s2">You are a friendly robot called $robot_name. You try to help the user to the best of your abilities.</span>
<span class="linenos"> 29</span><span class="s2">You are always helpful, and ask further questions if the desires of the user are unclear.</span>
<span class="linenos"> 30</span><span class="s2">Your answers are always polite yet concise and to-the-point.</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="s2">Your aim is to extract the user goal.</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="s2">Your response must be a JSON object with the following fields (both are optional):</span>
<span class="linenos"> 35</span><span class="s2">- verbal_ack: a string acknowledging the user request (like &#39;Sure&#39;, &#39;I&#39;m on it&#39;...)</span>
<span class="linenos"> 36</span><span class="s2">- user_intent: the user overall goal (intent), with the following fields:</span>
<span class="linenos"> 37</span><span class="s2">  - type: the type of intent to perform (e.g. &quot;__intent_say__&quot;, &quot;__intent_greet__&quot;, &quot;__intent_start_activity__&quot;, etc.)</span>
<span class="linenos"> 38</span><span class="s2">  - any thematic role required by the intent. For instance: `object` to</span>
<span class="linenos"> 39</span><span class="s2">    relate the intent to the object to interact with (e.g. &quot;lamp&quot;,</span>
<span class="linenos"> 40</span><span class="s2">    &quot;door&quot;, etc.)</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="s2">Importantly, `verbal_ack` is meant to be a *short* acknowledgement sentence,</span>
<span class="linenos"> 43</span><span class="s2">unconditionally uttered by the robot, indicating that you have understood the request -- or that we need more information.</span>
<span class="linenos"> 44</span><span class="s2">For more complex verbal actions, return a `__intent_say__` instead.</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="s2">However, for answers to general questions that do not require any action</span>
<span class="linenos"> 47</span><span class="s2">(eg: &#39;what is your name?&#39;), the &#39;user_intent&#39; field can be omitted, and the</span>
<span class="linenos"> 48</span><span class="s2">&#39;verbal_ack&#39; field should contain the answer.</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="s2">The user_id of the person you are talking to is $user_id. Always use this ID when referring to the person in your responses.</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="s2">Examples</span>
<span class="linenos"> 53</span><span class="s2">- if the user says &#39;Hello robot&#39;, you could respond:</span>
<span class="linenos"> 54</span><span class="s2">{</span>
<span class="linenos"> 55</span><span class="s2">    &quot;user_intent&quot;: {&quot;type&quot;: &quot;__intent_greet__&quot;, &quot;recipient&quot;: &quot;$user_id&quot;}</span>
<span class="linenos"> 56</span><span class="s2">}</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="s2">- if the user says &#39;What is your name?&#39;, you could respond:</span>
<span class="linenos"> 59</span><span class="s2">{</span>
<span class="linenos"> 60</span><span class="s2">    &quot;verbal_ack&quot;:&quot;My name is $robot_name. What is your name?&quot;</span>
<span class="linenos"> 61</span><span class="s2">}</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="s2">- if the user say &#39;take a fruit&#39;, you could respond (assuming a object &#39;apple1&#39; of type &#39;Apple&#39; is visible):</span>
<span class="linenos"> 64</span><span class="s2">{</span>
<span class="linenos"> 65</span><span class="s2">    &quot;user_intent&quot;: {</span>
<span class="linenos"> 66</span><span class="s2">            &quot;type&quot;:&quot;__intent_grab_object__&quot;,</span>
<span class="linenos"> 67</span><span class="s2">            &quot;object&quot;:&quot;apple1&quot;,</span>
<span class="linenos"> 68</span><span class="s2">    },</span>
<span class="linenos"> 69</span><span class="s2">    &quot;verbal_ack&quot;: &quot;Sure&quot;</span>
<span class="linenos"> 70</span><span class="s2">}</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="s2">- if the user say &#39;take a fruit&#39;, but you do not know about any fruit. You could respond:</span>
<span class="linenos"> 73</span><span class="s2">{</span>
<span class="linenos"> 74</span><span class="s2">    &quot;verbal_ack&quot;: &quot;I haven&#39;t seen any fruits around. Do you want me to check in the kitchen?&quot;</span>
<span class="linenos"> 75</span><span class="s2">}</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="s2">- the user says: &#39;clean the table&#39;. You could return:</span>
<span class="linenos"> 78</span><span class="s2">{</span>
<span class="linenos"> 79</span><span class="s2">    &quot;user_intent&quot;: {</span>
<span class="linenos"> 80</span><span class="s2">        &quot;type&quot;:&quot;__intent_start_activity__&quot;,</span>
<span class="linenos"> 81</span><span class="s2">        &quot;object&quot;: &quot;cleaning_table&quot;</span>
<span class="linenos"> 82</span><span class="s2">    },</span>
<span class="linenos"> 83</span><span class="s2">    &quot;verbal_ack&quot;: &quot;Sure, I&#39;ll get started&quot;</span>
<span class="linenos"> 84</span><span class="s2">}</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="s2">If you are not sure about the intention of the user, return an empty user_intent and ask for confirmation with the verbal_ack field.</span>
<span class="linenos"> 87</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="c1"># Define the data models for the chatbot response and the user intent</span>
<span class="linenos"> 91</span><span class="k">class</span> <span class="nc">IntentModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos"> 92</span>    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">Intent</span><span class="o">.</span><span class="n">BRING_OBJECT</span><span class="p">,</span>
<span class="linenos"> 93</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GRAB_OBJECT</span><span class="p">,</span>
<span class="linenos"> 94</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">PLACE_OBJECT</span><span class="p">,</span>
<span class="linenos"> 95</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GUIDE</span><span class="p">,</span>
<span class="linenos"> 96</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">MOVE_TO</span><span class="p">,</span>
<span class="linenos"> 97</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">SAY</span><span class="p">,</span>
<span class="linenos"> 98</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">GREET</span><span class="p">,</span>
<span class="linenos"> 99</span>                  <span class="n">Intent</span><span class="o">.</span><span class="n">START_ACTIVITY</span><span class="p">,</span>
<span class="linenos">100</span>                  <span class="p">]</span>
<span class="linenos">101</span>    <span class="nb">object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">102</span>    <span class="n">recipient</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">103</span>    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">104</span>    <span class="n">goal</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">105</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="k">class</span> <span class="nc">ChatbotResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos">108</span>    <span class="n">verbal_ack</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">109</span>    <span class="n">user_intent</span><span class="p">:</span> <span class="n">IntentModel</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos">110</span><span class="c1">##################################################</span>
<span class="linenos">111</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="k">class</span> <span class="nc">BasicChatbot</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="linenos">114</span>
<span class="linenos">115</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">116</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;intent_extractor_chatbot&#39;</span><span class="p">)</span>
<span class="linenos">117</span>
<span class="linenos">118</span>        <span class="c1"># Declare ROS parameters. Should mimick the one listed in config/00-defaults.yaml</span>
<span class="linenos">119</span>        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span>
<span class="linenos">120</span>            <span class="s1">&#39;my_parameter&#39;</span><span class="p">,</span> <span class="s2">&quot;my_default_value.&quot;</span><span class="p">,</span>
<span class="linenos">121</span>            <span class="n">ParameterDescriptor</span><span class="p">(</span>
<span class="linenos">122</span>                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Important parameter for my chatbot&#39;</span><span class="p">)</span>
<span class="linenos">123</span>        <span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising...&quot;</span><span class="p">)</span>
<span class="linenos">126</span>
<span class="linenos">127</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_start_action</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">128</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_interaction_srv</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">129</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_supported_locales_server</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">130</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_locale_server</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">131</span>
<span class="linenos">132</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">133</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_pub</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">134</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_timer</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">135</span>
<span class="linenos">136</span>        <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">KB</span><span class="p">()</span>
<span class="linenos">137</span>
<span class="linenos">138</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">139</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_id</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">140</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">141</span>
<span class="linenos">142</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_ollama_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="linenos">143</span>        <span class="c1"># if ollama does not run on the local host, you can specify the host and</span>
<span class="linenos">144</span>        <span class="c1"># port. For instance:</span>
<span class="linenos">145</span>        <span class="c1"># self._ollama_client = Client(&quot;x.x.x.x:11434&quot;)</span>
<span class="linenos">146</span>
<span class="linenos">147</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">148</span>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
<span class="linenos">149</span>             <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span><span class="n">PROMPT</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">robot_name</span><span class="o">=</span><span class="s2">&quot;Robbie&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user1&quot;</span><span class="p">)</span>
<span class="linenos">150</span>             <span class="p">}]</span>
<span class="linenos">151</span>
<span class="linenos">152</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chatbot chatbot started, but not yet configured.&#39;</span><span class="p">)</span>
<span class="linenos">153</span>
<span class="linenos">154</span>    <span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">155</span>        <span class="n">environment_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">156</span>
<span class="linenos">157</span>        <span class="n">seen_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="p">[</span><span class="s2">&quot;myself sees ?obj&quot;</span><span class="p">]</span>
<span class="linenos">158</span>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seen_objects</span><span class="p">]:</span>
<span class="linenos">159</span>            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">details</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">160</span>            <span class="n">label</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
<span class="linenos">161</span>            <span class="n">classes</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
<span class="linenos">162</span>            <span class="n">class_name</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">163</span>            <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
<span class="linenos">164</span>                <span class="n">class_name</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
<span class="linenos">165</span>                <span class="n">environment_description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- I see a </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2"> labeled </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="linenos">166</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">167</span>                <span class="n">environment_description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- I see </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="linenos">168</span>
<span class="linenos">169</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="linenos">170</span>            <span class="sa">f</span><span class="s2">&quot;Environment description:</span><span class="se">\n</span><span class="si">{</span><span class="n">environment_description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">171</span>        <span class="k">return</span> <span class="n">environment_description</span>
<span class="linenos">172</span>
<span class="linenos">173</span>    <span class="k">def</span> <span class="nf">on_dialog_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Dialogue</span><span class="o">.</span><span class="n">Goal</span><span class="p">):</span>
<span class="linenos">174</span>        <span class="c1"># Here we check if the goal is valid and the node is able to accept it</span>
<span class="linenos">175</span>        <span class="c1">#</span>
<span class="linenos">176</span>        <span class="c1"># For simplicity, we allow only one dialogue at a time.</span>
<span class="linenos">177</span>        <span class="c1"># You might want to change this to allow multiple dialogues at the same time.</span>
<span class="linenos">178</span>        <span class="c1">#</span>
<span class="linenos">179</span>        <span class="c1"># We also check if the dialogue role is supported by the chatbot.</span>
<span class="linenos">180</span>        <span class="c1"># In this example, we only support only the &quot;__default__&quot; role.</span>
<span class="linenos">181</span>
<span class="linenos">182</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_id</span> <span class="ow">or</span> <span class="n">goal</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;__default__&#39;</span><span class="p">:</span>
<span class="linenos">183</span>            <span class="k">return</span> <span class="n">GoalResponse</span><span class="o">.</span><span class="n">REJECT</span>
<span class="linenos">184</span>        <span class="k">return</span> <span class="n">GoalResponse</span><span class="o">.</span><span class="n">ACCEPT</span>
<span class="linenos">185</span>
<span class="linenos">186</span>    <span class="k">def</span> <span class="nf">on_dialog_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ServerGoalHandle</span><span class="p">):</span>
<span class="linenos">187</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_id</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">goal_id</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">189</span>        <span class="n">handle</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="linenos">190</span>
<span class="linenos">191</span>    <span class="k">def</span> <span class="nf">on_dialog_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ServerGoalHandle</span><span class="p">):</span>
<span class="linenos">192</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_id</span><span class="p">:</span>
<span class="linenos">193</span>            <span class="k">return</span> <span class="n">CancelResponse</span><span class="o">.</span><span class="n">ACCEPT</span>
<span class="linenos">194</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">195</span>            <span class="k">return</span> <span class="n">CancelResponse</span><span class="o">.</span><span class="n">REJECT</span>
<span class="linenos">196</span>
<span class="linenos">197</span>    <span class="k">def</span> <span class="nf">on_dialog_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">ServerGoalHandle</span><span class="p">):</span>
<span class="linenos">198</span>        <span class="nb">id</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">goal_id</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="linenos">200</span>            <span class="sa">f</span><span class="s2">&quot;Starting &#39;</span><span class="si">{</span><span class="n">handle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; dialogue with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">201</span>
<span class="linenos">202</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">203</span>            <span class="k">while</span> <span class="n">handle</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
<span class="linenos">204</span>                <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">is_cancel_requested</span><span class="p">:</span>
<span class="linenos">205</span>                    <span class="n">handle</span><span class="o">.</span><span class="n">canceled</span><span class="p">()</span>
<span class="linenos">206</span>                    <span class="k">return</span> <span class="n">Dialogue</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">error_msg</span><span class="o">=</span><span class="s1">&#39;Dialogue cancelled&#39;</span><span class="p">)</span>
<span class="linenos">207</span>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span><span class="p">:</span>
<span class="linenos">208</span>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">:</span>
<span class="linenos">209</span>                        <span class="n">handle</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
<span class="linenos">210</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">211</span>                        <span class="n">handle</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
<span class="linenos">212</span>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span>
<span class="linenos">213</span>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="linenos">214</span>            <span class="k">return</span> <span class="n">Dialogue</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">error_msg</span><span class="o">=</span><span class="s1">&#39;Dialogue execution interrupted&#39;</span><span class="p">)</span>
<span class="linenos">215</span>        <span class="k">finally</span><span class="p">:</span>
<span class="linenos">216</span>            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dialogue with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> finished&quot;</span><span class="p">)</span>
<span class="linenos">217</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_id</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">218</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_result</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">219</span>
<span class="linenos">220</span>    <span class="k">def</span> <span class="nf">on_dialogue_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="linenos">221</span>                                <span class="n">request</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<span class="linenos">222</span>                                <span class="n">response</span><span class="p">:</span> <span class="n">DialogueInteraction</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="linenos">223</span>
<span class="linenos">224</span>        <span class="n">target_dialogue_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dialogue_id</span>
<span class="linenos">225</span>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span>
<span class="linenos">226</span>        <span class="nb">input</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">input</span>
<span class="linenos">227</span>        <span class="n">response_expected</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">response_expected</span>
<span class="linenos">228</span>        <span class="n">suggested_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">229</span>        <span class="n">intents</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">230</span>
<span class="linenos">231</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="linenos">232</span>            <span class="sa">f</span><span class="s2">&quot;input from </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> to dialogue </span><span class="si">{</span><span class="n">target_dialogue_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">233</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">234</span>
<span class="linenos">235</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">()})</span>
<span class="linenos">236</span>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})</span>
<span class="linenos">237</span>
<span class="linenos">238</span>        <span class="n">llm_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ollama_client</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<span class="linenos">239</span>            <span class="n">messages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
<span class="linenos">240</span>            <span class="c1"># you can also try with more powerful models, see https://ollama.com/models</span>
<span class="linenos">241</span>            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gemma3:1b&quot;</span><span class="p">,</span>
<span class="linenos">242</span>            <span class="nb">format</span><span class="o">=</span><span class="n">ChatbotResponse</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>
<span class="linenos">243</span>        <span class="p">)</span>
<span class="linenos">244</span>
<span class="linenos">245</span>        <span class="n">json_res</span> <span class="o">=</span> <span class="n">ChatbotResponse</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">llm_res</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="linenos">246</span>
<span class="linenos">247</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The LLM answered: </span><span class="si">{</span><span class="n">json_res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">248</span>
<span class="linenos">249</span>        <span class="n">verbal_ack</span> <span class="o">=</span> <span class="n">json_res</span><span class="o">.</span><span class="n">verbal_ack</span>
<span class="linenos">250</span>        <span class="k">if</span> <span class="n">verbal_ack</span><span class="p">:</span>
<span class="linenos">251</span>            <span class="c1"># if we have a verbal acknowledgement, add it to the dialogue history,</span>
<span class="linenos">252</span>            <span class="c1"># and send it to the user</span>
<span class="linenos">253</span>            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">verbal_ack</span><span class="p">})</span>
<span class="linenos">254</span>            <span class="n">response</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">verbal_ack</span>
<span class="linenos">255</span>
<span class="linenos">256</span>        <span class="n">user_intent</span> <span class="o">=</span> <span class="n">json_res</span><span class="o">.</span><span class="n">user_intent</span>
<span class="linenos">257</span>        <span class="k">if</span> <span class="n">user_intent</span><span class="p">:</span>
<span class="linenos">258</span>            <span class="n">response</span><span class="o">.</span><span class="n">intents</span> <span class="o">=</span> <span class="p">[</span><span class="n">Intent</span><span class="p">(</span>
<span class="linenos">259</span>                <span class="n">intent</span><span class="o">=</span><span class="n">user_intent</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="linenos">260</span>                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">user_intent</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
<span class="linenos">261</span>            <span class="p">)]</span>
<span class="linenos">262</span>
<span class="linenos">263</span>        <span class="k">return</span> <span class="n">response</span>
<span class="linenos">264</span>
<span class="linenos">265</span>    <span class="k">def</span> <span class="nf">on_get_supported_locales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="linenos">266</span>        <span class="n">response</span><span class="o">.</span><span class="n">locales</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of supported locales; empty means any</span>
<span class="linenos">267</span>        <span class="k">return</span> <span class="n">response</span>
<span class="linenos">268</span>
<span class="linenos">269</span>    <span class="k">def</span> <span class="nf">on_set_default_locale_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_request</span><span class="p">):</span>
<span class="linenos">270</span>        <span class="k">return</span> <span class="n">GoalResponse</span><span class="o">.</span><span class="n">ACCEPT</span>
<span class="linenos">271</span>
<span class="linenos">272</span>    <span class="k">def</span> <span class="nf">on_set_default_locale_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_handle</span><span class="p">):</span>
<span class="linenos">273</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Change here the default locale of the chatbot.&quot;&quot;&quot;</span>
<span class="linenos">274</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">SetLocale</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>
<span class="linenos">275</span>        <span class="n">goal_handle</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
<span class="linenos">276</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos">277</span>
<span class="linenos">278</span>    <span class="c1">#################################</span>
<span class="linenos">279</span>    <span class="c1">#</span>
<span class="linenos">280</span>    <span class="c1"># Lifecycle transitions callbacks</span>
<span class="linenos">281</span>    <span class="c1">#</span>
<span class="linenos">282</span>    <span class="k">def</span> <span class="nf">on_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
<span class="linenos">283</span>
<span class="linenos">284</span>        <span class="c1"># configure and start diagnostics publishing</span>
<span class="linenos">285</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">286</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
<span class="linenos">287</span>            <span class="n">DiagnosticArray</span><span class="p">,</span> <span class="s1">&#39;/diagnostics&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">288</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish_diagnostics</span><span class="p">)</span>
<span class="linenos">289</span>
<span class="linenos">290</span>        <span class="c1"># start advertising supported locales</span>
<span class="linenos">291</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_supported_locales_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span>
<span class="linenos">292</span>            <span class="n">GetLocales</span><span class="p">,</span> <span class="s2">&quot;~/get_supported_locales&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_get_supported_locales</span><span class="p">)</span>
<span class="linenos">293</span>
<span class="linenos">294</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_locale_server</span> <span class="o">=</span> <span class="n">ActionServer</span><span class="p">(</span>
<span class="linenos">295</span>            <span class="bp">self</span><span class="p">,</span> <span class="n">SetLocale</span><span class="p">,</span> <span class="s2">&quot;~/set_default_locale&quot;</span><span class="p">,</span>
<span class="linenos">296</span>            <span class="n">goal_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_set_default_locale_goal</span><span class="p">,</span>
<span class="linenos">297</span>            <span class="n">execute_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_set_default_locale_exec</span><span class="p">)</span>
<span class="linenos">298</span>
<span class="linenos">299</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chatbot chatbot is configured, but not yet active&quot;</span><span class="p">)</span>
<span class="linenos">300</span>        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span>
<span class="linenos">301</span>
<span class="linenos">302</span>    <span class="k">def</span> <span class="nf">on_activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
<span class="linenos">303</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">304</span><span class="sd">        Activate the node.</span>
<span class="linenos">305</span>
<span class="linenos">306</span><span class="sd">        You usually want to do the following in this state:</span>
<span class="linenos">307</span><span class="sd">        - Create and start any timers performing periodic tasks</span>
<span class="linenos">308</span><span class="sd">        - Start processing data, and accepting action goals, if any</span>
<span class="linenos">309</span>
<span class="linenos">310</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">311</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_start_action</span> <span class="o">=</span> <span class="n">ActionServer</span><span class="p">(</span>
<span class="linenos">312</span>            <span class="bp">self</span><span class="p">,</span> <span class="n">Dialogue</span><span class="p">,</span> <span class="s1">&#39;/chatbot/start_dialogue&#39;</span><span class="p">,</span>
<span class="linenos">313</span>            <span class="n">execute_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dialog_execute</span><span class="p">,</span>
<span class="linenos">314</span>            <span class="n">goal_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dialog_goal</span><span class="p">,</span>
<span class="linenos">315</span>            <span class="n">handle_accepted_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dialog_accept</span><span class="p">,</span>
<span class="linenos">316</span>            <span class="n">cancel_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dialog_cancel</span><span class="p">,</span>
<span class="linenos">317</span>            <span class="n">callback_group</span><span class="o">=</span><span class="n">ReentrantCallbackGroup</span><span class="p">())</span>
<span class="linenos">318</span>
<span class="linenos">319</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_interaction_srv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span>
<span class="linenos">320</span>            <span class="n">DialogueInteraction</span><span class="p">,</span> <span class="s1">&#39;/chatbot/dialogue_interaction&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_dialogue_interaction</span><span class="p">)</span>
<span class="linenos">321</span>
<span class="linenos">322</span>        <span class="c1"># Define a timer that fires every second to call the run function</span>
<span class="linenos">323</span>        <span class="n">timer_period</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># in sec</span>
<span class="linenos">324</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="n">timer_period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
<span class="linenos">325</span>
<span class="linenos">326</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chatbot chatbot is active and running&quot;</span><span class="p">)</span>
<span class="linenos">327</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_activate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">328</span>
<span class="linenos">329</span>    <span class="k">def</span> <span class="nf">on_deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
<span class="linenos">330</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the timer to stop calling the `run` function (main task of your application).&quot;&quot;&quot;</span>
<span class="linenos">331</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping chatbot...&quot;</span><span class="p">)</span>
<span class="linenos">332</span>
<span class="linenos">333</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">)</span>
<span class="linenos">334</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_start_action</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
<span class="linenos">335</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dialogue_interaction_srv</span><span class="p">)</span>
<span class="linenos">336</span>
<span class="linenos">337</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chatbot chatbot is stopped (inactive)&quot;</span><span class="p">)</span>
<span class="linenos">338</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_deactivate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">339</span>
<span class="linenos">340</span>    <span class="k">def</span> <span class="nf">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransitionCallbackReturn</span><span class="p">:</span>
<span class="linenos">341</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">342</span><span class="sd">        Shutdown the node, after a shutting-down transition is requested.</span>
<span class="linenos">343</span>
<span class="linenos">344</span><span class="sd">        :return: The state machine either invokes a transition to the</span>
<span class="linenos">345</span><span class="sd">            &quot;finalized&quot; state or stays in the current state depending on the</span>
<span class="linenos">346</span><span class="sd">            return value.</span>
<span class="linenos">347</span><span class="sd">            TransitionCallbackReturn.SUCCESS transitions to &quot;finalized&quot;.</span>
<span class="linenos">348</span><span class="sd">            TransitionCallbackReturn.FAILURE remains in current state.</span>
<span class="linenos">349</span><span class="sd">            TransitionCallbackReturn.ERROR or any uncaught exceptions to</span>
<span class="linenos">350</span><span class="sd">            &quot;errorprocessing&quot;</span>
<span class="linenos">351</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">352</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutting down chatbot node.&#39;</span><span class="p">)</span>
<span class="linenos">353</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diag_timer</span><span class="p">)</span>
<span class="linenos">354</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diag_pub</span><span class="p">)</span>
<span class="linenos">355</span>
<span class="linenos">356</span>        <span class="bp">self</span><span class="o">.</span><span class="n">destroy_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_supported_locales_server</span><span class="p">)</span>
<span class="linenos">357</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_locale_server</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
<span class="linenos">358</span>
<span class="linenos">359</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chatbot chatbot finalized.&quot;</span><span class="p">)</span>
<span class="linenos">360</span>        <span class="k">return</span> <span class="n">TransitionCallbackReturn</span><span class="o">.</span><span class="n">SUCCESS</span>
<span class="linenos">361</span>
<span class="linenos">362</span>    <span class="c1">#################################</span>
<span class="linenos">363</span>
<span class="linenos">364</span>    <span class="k">def</span> <span class="nf">publish_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">365</span>
<span class="linenos">366</span>        <span class="n">arr</span> <span class="o">=</span> <span class="n">DiagnosticArray</span><span class="p">()</span>
<span class="linenos">367</span>        <span class="n">msg</span> <span class="o">=</span> <span class="n">DiagnosticStatus</span><span class="p">(</span>
<span class="linenos">368</span>            <span class="n">level</span><span class="o">=</span><span class="n">DiagnosticStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span>
<span class="linenos">369</span>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;/intent_extractor_chatbot&quot;</span><span class="p">,</span>
<span class="linenos">370</span>            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;chatbot chatbot is running&quot;</span><span class="p">,</span>
<span class="linenos">371</span>            <span class="n">values</span><span class="o">=</span><span class="p">[</span>
<span class="linenos">372</span>                <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Module name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;chatbot&quot;</span><span class="p">),</span>
<span class="linenos">373</span>                <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Current lifecycle state&quot;</span><span class="p">,</span>
<span class="linenos">374</span>                         <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_machine</span><span class="o">.</span><span class="n">current_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="linenos">375</span>                <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;# requests since start&quot;</span><span class="p">,</span>
<span class="linenos">376</span>                         <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nb_requests</span><span class="p">)),</span>
<span class="linenos">377</span>            <span class="p">],</span>
<span class="linenos">378</span>        <span class="p">)</span>
<span class="linenos">379</span>
<span class="linenos">380</span>        <span class="n">arr</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>
<span class="linenos">381</span>        <span class="n">arr</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
<span class="linenos">382</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">383</span>
<span class="linenos">384</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">385</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">386</span><span class="sd">        Background task of the chatbot.</span>
<span class="linenos">387</span>
<span class="linenos">388</span><span class="sd">        For now, we do not need to do anything here, as the chatbot is</span>
<span class="linenos">389</span><span class="sd">        event-driven, and the `on_user_input` callback is called when a new</span>
<span class="linenos">390</span><span class="sd">        user input is received.</span>
<span class="linenos">391</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">392</span>        <span class="k">pass</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Link to this heading">ÔÉÅ</a></h2>
<figure class="align-default" id="id16">
<a class="reference internal image-reference" href="../../_images/interaction-simulator-architecture-final.svg"><img alt="Interaction simulator architecture" src="../../_images/interaction-simulator-architecture-final.svg" style="width: 70%;" />
</a>
<figcaption>
<p><span class="caption-text">Interaction simulator architecture</span><a class="headerlink" href="#id16" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
<p>We have completed a simple social robot architecture, with a mission
controller that can react to user intents, and a chatbot that can
extract intents from user.</p>
<p>You can now:</p>
<ul class="simple">
<li><p><strong>Extend the mission controller</strong>: add more intents, more complex
behaviours, etc;</p></li>
<li><p><strong>Structure your application</strong>: split your mission controller into
tasks and skills, and orchestrate them;</p></li>
<li><p><strong>Integrate navigation and manipulation</strong>, using the corresponding
<a class="reference external" href="https://docs.pal-robotics.com/edge/navigation/skills_list">navigation
skills</a>
and <a class="reference external" href="https://docs.pal-robotics.com/edge/manipulation/skills_list">manipulation
skills</a></p></li>
<li><p>Finally, <strong>deploy your application</strong> on a real robot. For PAL robots,
you can use the <a class="reference external" href="https://docs.pal-robotics.com/edge/development/deploy-code">PAL Robotics‚Äô
tools</a>;</p></li>
</ul>
<figure class="align-default" id="id17" style="width: 70%">
<a class="reference internal image-reference" href="../../_images/logos.svg"><img alt="Horizon Europe ARISE and TRAIL logos" src="../../_images/logos.svg" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Horizon Europe ARISE and TRAIL logos</span><a class="headerlink" href="#id17" title="Link to this image">ÔÉÅ</a></p>
</figcaption>
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../robots.html" class="btn btn-neutral float-right" title="Compatible Robots" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright PAL Robotics S.L..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

<style>
  /* Sidebar header (and topbar for mobile) */
  .wy-side-nav-search,
  .wy-nav-top {
    background: #464646;
  }

  .wy-nav-content {
    max-width: none;
  }

  /* Sidebar */
  .wy-nav-side {
    background: #136264;
  }
</style>


</body>
</html>